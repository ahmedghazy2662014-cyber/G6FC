<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grade 6B FC</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --primary: #00ff9c;
  --primary-dark: #00cc7d;
  --bg-dark: #0a0f1f;
  --bg-card: #111827;
  --bg-input: #020617;
  --text-main: #e6f1ff;
  --text-muted: #888;
  --danger: #ff4d4d;
  --warning: #fbbf24;
  --success: #00ff9c;
  --card-gold: #f4d03f;
  --card-blue: #3498db;
}

/* ===== RESET & BASE ===== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  overflow-x: hidden;
}

body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #0a0f1f 0%, #1a1f3a 100%);
  color: #e6f1ff;
  min-height: 100vh;
}

/* ===== MOBILE RESPONSIVE ===== */
@media (max-width: 768px) {
  .tab-container {
    gap: 10px;
    padding: 0 10px;
  }
  
  .tab {
    padding: 6px 12px;
    font-size: 14px;
  }
  
  .squad-builder-container {
    grid-template-columns: 1fr !important;
    height: auto !important;
    min-height: auto !important;
  }
  
  .squad-sidebar {
    order: 2;
    height: auto;
    min-height: 300px;
    max-height: none !important;
  }
  
  .squad-main {
    order: 1;
    height: 500px;
  }
  
  .player-slot {
    width: 70px !important;
    height: 90px !important;
  }
  
  .player-card-photo {
    width: 45px !important;
    height: 45px !important;
  }
  
  .list-header, .row {
    min-width: auto !important;
    grid-template-columns: 30px 100px 60px repeat(6,45px) 45px 35px 35px 35px 80px !important;
    font-size: 12px;
  }
  
  .setup-grid {
    grid-template-columns: 1fr !important;
  }
  
  .match-item {
    flex-direction: column !important;
    gap: 10px !important;
  }
  
  .match-score {
    order: -1;
  }
  
  .formation-canvas {
    height: 400px !important;
  }
  
  .pool-container {
    max-height: 300px !important;
  }
}

.hidden {
  display: none !important;
}

button, input, select {
  cursor: pointer;
  font-family: inherit;
}

input, select, textarea {
  background: #020617;
  color: white;
  border: 1px solid #333;
  border-radius: 4px;
  padding: 5px;
  transition: 0.2s;
}

input:hover, select:hover, textarea:hover {
  border-color: #00ff9c;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #00ff9c;
  box-shadow: 0 0 5px rgba(0,255,156,0.3);
}

textarea {
  width: 100%;
  resize: none;
  overflow: hidden;
}

/* ===== SYNC STATUS ===== */
#syncStatus {
  position: fixed;
  top: 10px;
  right: 10px;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
  z-index: 1000;
  transition: all 0.3s;
}

.sync-connected {
  background: rgba(0, 255, 156, 0.2);
  color: #00ff9c;
  border: 1px solid #00ff9c;
}

.sync-connecting {
  background: rgba(251, 191, 36, 0.2);
  color: #fbbf24;
  border: 1px solid #fbbf24;
}

.sync-error {
  background: rgba(255, 77, 77, 0.2);
  color: #ff4d4d;
  border: 1px solid #ff4d4d;
}

/* ===== HEADER ===== */
header {
  padding: 15px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(0,0,0,0.3);
  position: sticky;
  top: 0;
  z-index: 100;
  flex-shrink: 0;
}

#viewerDisplay {
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 4px;
  transition: 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

#viewerDisplay:hover {
  background: rgba(0,255,156,0.1);
}

#editNameBtn {
  cursor: pointer;
  font-size: 14px;
  color: #00ff9c;
  padding: 2px 5px;
  border-radius: 3px;
  transition: 0.2s;
}

#editNameBtn:hover {
  background: rgba(0,255,156,0.2);
}

#adminBadge {
  font-size: 12px;
  color: #888;
}

/* ===== TAB NAVIGATION ===== */
.tab-container {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 15px 0;
  flex-wrap: wrap;
  flex-shrink: 0;
}

.tab {
  cursor: pointer;
  color: #aaa;
  padding: 8px 16px;
  border-radius: 4px;
  transition: 0.2s;
  font-weight: 500;
  background: rgba(0,0,0,0.3);
  border: 1px solid transparent;
}

.tab.active, .tab:hover {
  background: #00ff9c;
  color: black;
  border-color: #00ff9c;
}

/* ===== MAIN CONTAINERS ===== */
.container {
  width: 95%;
  margin: auto;
  max-width: 1400px;
  max-height: calc(100vh - 150px);
  overflow-y: auto;
}

.list, .teamPage, .statPage, .matchPage {
  background: #020617;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  max-height: calc(100vh - 150px);
  overflow-y: auto;
}

/* ===== PLAYER LIST STYLES ===== */
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.list-header, .row {
  display: grid;
  grid-template-columns: 40px 160px 80px repeat(6,65px) 60px 50px 50px 50px 120px;
  gap: 6px;
  align-items: center;
  min-width: 1350px;
}

.list-header {
  color: #00ff9c;
  border-bottom: 2px solid #00ff9c;
  padding-bottom: 8px;
  font-weight: bold;
}

.row {
  background: #111827;
  border-radius: 6px;
  padding: 8px;
  margin-top: 6px;
  transition: 0.2s;
}

.row:hover {
  background: #1a2233;
  transform: translateX(2px);
}

.icon {
  cursor: pointer;
  padding: 5px;
  border-radius: 4px;
  transition: 0.2s;
}

.icon:hover {
  color: #00ff9c;
  background: rgba(0,255,156,0.1);
}

/* ===== COMMENTS ===== */
.commentSection {
  margin-top: 15px;
  background: #020617;
  padding: 15px;
  border-radius: 10px;
}

.comment {
  border-bottom: 1px solid #333;
  padding: 8px 0;
  position: relative;
}

.comment:last-child {
  border-bottom: none;
}

.comment-actions {
  margin-top: 5px;
  display: flex;
  gap: 15px;
  font-size: 13px;
}

.comment-btn {
  cursor: pointer;
  color: #888;
  transition: 0.2s;
  user-select: none;
}

.comment-btn:hover {
  color: #00ff9c;
}

.comment-btn.liked {
  color: #00ff9c;
}

.comment-btn.disliked {
  color: #ff4d4d;
}

/* ===== STATS PAGE ===== */
.statGrid {
  display: grid;
  grid-template-columns: repeat(6,1fr);
  text-align: center;
  margin: 15px 0;
  gap: 10px;
}

.statBox {
  background: #111827;
  padding: 15px;
  border-radius: 8px;
  transition: 0.2s;
}

.statBox:hover {
  transform: translateY(-2px);
  background: #1a2233;
}

.photo {
  width: 150px;
  height: 150px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid #00ff9c;
}

.badgeIcon {
  display: inline-block;
  margin: 2px;
  background: #00ff9c;
  color: black;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
}

.displayedTraitsBadges {
  margin-top: 15px;
  padding: 10px;
  background: #111827;
  border-radius: 8px;
}

.photoWrapper {
  position: relative;
  display: inline-block;
  margin-bottom: 15px;
}

#removePhotoBtn {
  position: absolute;
  top: -10px;
  right: -10px;
  background: #ff4d4d;
  color: white;
  border: none;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  cursor: pointer;
  font-weight: bold;
}

.admin-only {
  display: none !important;
}

.admin .admin-only {
  display: block !important;
}

.admin .admin-only-inline {
  display: inline-block !important;
}

.viewer-message {
  text-align: center;
  padding: 60px 20px;
  color: #888;
}

.viewer-message h2 {
  color: #00ff9c;
  margin-bottom: 10px;
}

/* ===== SETUP PAGE STYLES ===== */
.setup-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  overflow-y: auto;
  max-height: calc(100vh - 200px);
}

.setup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #333;
  flex-wrap: wrap;
  gap: 15px;
}

.setup-title {
  font-size: 28px;
  color: #00ff9c;
  margin: 0;
}

.setup-controls {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.team-count-control {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #111827;
  padding: 10px 20px;
  border-radius: 8px;
}

.team-count-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  background: #00ff9c;
  color: black;
  border: none;
  font-weight: bold;
}

.team-count-display {
  font-size: 24px;
  font-weight: bold;
  min-width: 40px;
  text-align: center;
}

.setup-actions {
  display: flex;
  gap: 10px;
}

.setup-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.setup-card {
  background: #111827;
  border: 2px solid #333;
  border-radius: 12px;
  padding: 20px;
  transition: 0.2s;
}

.setup-card:hover {
  border-color: #00ff9c;
  transform: translateY(-2px);
}

.setup-card-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.setup-card-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #00ff9c;
  background: #0a0f1f;
}

.setup-card-icon-placeholder {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #0a0f1f;
  border: 2px dashed #555;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: #555;
}

.setup-card-info {
  flex: 1;
}

.setup-card-title {
  font-size: 18px;
  font-weight: bold;
  color: #fff;
  margin-bottom: 5px;
}

.setup-card-meta {
  font-size: 12px;
  color: #888;
}

.setup-card-body {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.setup-input-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.setup-input-group label {
  font-size: 12px;
  color: #888;
  text-transform: uppercase;
}

.setup-card-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.setup-card-actions button {
  flex: 1;
  font-size: 12px;
  padding: 8px;
}

.btn-secondary {
  background: #333;
  color: white;
}

.btn-secondary:hover {
  background: #444;
}

.btn-danger {
  background: #ff4d4d;
  color: white;
}

.btn-danger:hover {
  background: #ff3333;
}

.btn-warning {
  background: #fbbf24;
  color: black;
}

.btn-warning:hover {
  background: #f59e0b;
}

.setup-footer {
  display: flex;
  justify-content: center;
  gap: 20px;
  padding-top: 20px;
  border-top: 2px solid #333;
  flex-wrap: wrap;
}

.setup-footer button {
  padding: 15px 40px;
  font-size: 16px;
}

/* ===== FORMATION BUILDER ===== */
.formation-workspace {
  background: #0a0f1f;
  border: 2px solid #333;
  border-radius: 12px;
  padding: 20px;
  margin-top: 15px;
}

.formation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  flex-wrap: wrap;
  gap: 10px;
}

.formation-player-count {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #1a2233;
  padding: 8px 15px;
  border-radius: 8px;
}

.formation-canvas {
  background: linear-gradient(180deg, #1a3a1a 0%, #0d260d 100%);
  border-radius: 12px;
  height: 500px;
  position: relative;
  overflow: hidden;
  border: 3px solid #333;
  margin-bottom: 15px;
}

.formation-canvas::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 10%;
  right: 10%;
  height: 2px;
  background: rgba(255,255,255,0.2);
  transform: translateY(-50%);
}

.formation-canvas::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 80px;
  height: 80px;
  border: 2px solid rgba(255,255,255,0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

.formation-position {
  position: absolute;
  width: 70px;
  height: 90px;
  background: rgba(0,0,0,0.8);
  border: 2px dashed #555;
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  transform: translate(-50%, -50%);
}

.formation-position:hover {
  border-color: #00ff9c;
  background: rgba(0,255,156,0.1);
  transform: translate(-50%, -50%) scale(1.05);
}

.formation-position.occupied {
  border-style: solid;
  border-color: #00ff9c;
  background: rgba(0,0,0,0.9);
  box-shadow: 0 4px 15px rgba(0,255,156,0.3);
}

.formation-position.selected {
  border-color: #fbbf24;
  background: rgba(251, 191, 36, 0.2);
}

.formation-position-pos {
  font-size: 14px;
  font-weight: bold;
  color: #00ff9c;
  margin-bottom: 4px;
}

.formation-position-index {
  font-size: 10px;
  color: #666;
}

.formation-position-remove {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ff4d4d;
  color: white;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  cursor: pointer;
  display: none;
}

.formation-position.occupied:hover .formation-position-remove {
  display: block;
}

.formation-instructions {
  background: #1a2233;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 13px;
  color: #aaa;
}

.formation-position-palette {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 15px;
}

.position-option {
  padding: 10px 15px;
  background: #1a2233;
  border: 2px solid #333;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: bold;
  transition: 0.2s;
  color: white;
}

.position-option:hover {
  border-color: #00ff9c;
  background: #252d3d;
}

.position-option.selected {
  border-color: #00ff9c;
  background: #00ff9c;
  color: black;
}

.formation-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: #1a2233;
  border-radius: 8px;
  font-size: 14px;
}

.formation-status.complete {
  background: rgba(0,255,156,0.1);
  border: 1px solid #00ff9c;
}

.formation-status.incomplete {
  background: rgba(255, 77, 77, 0.1);
  border: 1px solid #ff4d4d;
}

/* ===== SQUAD BUILDER STYLES ===== */
.squad-builder-container {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 20px;
  height: calc(100vh - 140px);
  min-height: 600px;
  overflow: hidden;
}

.squad-sidebar {
  background: #111827;
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  max-height: 100%;
}

/* Sidebar Sections */
.sidebar-section {
  padding: 15px;
  border-bottom: 1px solid #333;
}

.sidebar-section:last-child {
  border-bottom: none;
}

.sidebar-section-title {
  font-size: 14px;
  font-weight: bold;
  color: #00ff9c;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Team List Section */
.team-list-section {
  max-height: 150px;
  overflow-y: auto;
}

.team-list-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: #1a2233;
  border-radius: 6px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: 0.2s;
  border: 2px solid transparent;
}

.team-list-item:hover {
  border-color: #00ff9c;
}

.team-list-item.active {
  border-color: #00ff9c;
  background: #252d3d;
}

.team-list-icon {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  object-fit: cover;
}

.team-list-info {
  flex: 1;
}

.team-list-name {
  font-size: 13px;
  font-weight: bold;
  color: #fff;
}

.team-list-stats {
  font-size: 11px;
  color: #888;
}

/* Pool Container - Flexible height */
.pool-container {
  background: #0a0f1f;
  border-radius: 8px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 200px;
  overflow: hidden;
}

.pool-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.pool-title {
  font-weight: bold;
  color: #00ff9c;
  font-size: 14px;
}

.pool-search {
  margin-bottom: 10px;
  width: 100%;
  padding: 8px;
  font-size: 13px;
}

.pool-list {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 0;
}

.pool-player {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  background: #1a2233;
  border-radius: 6px;
  cursor: grab;
  transition: 0.2s;
  border: 1px solid transparent;
  flex-shrink: 0;
}

.pool-player:hover {
  border-color: #00ff9c;
  background: #252d3d;
}

.pool-player.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.pool-player-photo {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #00ff9c;
}

.pool-player-info {
  flex: 1;
  min-width: 0;
}

.pool-player-name {
  font-size: 12px;
  font-weight: bold;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.pool-player-stats {
  font-size: 10px;
  color: #888;
}

.pool-player-ovr {
  background: #00ff9c;
  color: #000;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
  flex-shrink: 0;
}

.pool-hint {
  font-size: 11px;
  color: #666;
  text-align: center;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #333;
}

/* Admin Controls Section - Fixed at bottom */
.admin-controls-section {
  padding: 15px;
  background: #0a0f1f;
  border-top: 2px solid #333;
  flex-shrink: 0;
}

.admin-controls-section button {
  width: 100%;
  margin-bottom: 8px;
  padding: 10px;
  font-size: 13px;
}

.admin-controls-section button:last-child {
  margin-bottom: 0;
}

/* Viewer Hint Section */
.viewer-hint-section {
  padding: 15px;
  background: #0a0f1f;
  border-top: 2px solid #333;
  text-align: center;
  color: #888;
  font-size: 12px;
  flex-shrink: 0;
}

.squad-main {
  background: linear-gradient(180deg, #1a3a1a 0%, #0d260d 100%);
  border-radius: 10px;
  position: relative;
  overflow: hidden;
  border: 2px solid #333;
  display: flex;
  flex-direction: column;
}

/* Pitch Lines */
.pitch-lines {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  z-index: 1;
}

.pitch-line {
  position: absolute;
  border: 2px solid rgba(255,255,255,0.3);
}

.pitch-center-line {
  top: 50%;
  left: 10%;
  right: 10%;
  height: 0;
  border-top: 2px solid rgba(255,255,255,0.3);
}

.pitch-center-circle {
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.3);
}

.pitch-box-top {
  top: 0;
  left: 30%;
  right: 30%;
  height: 15%;
  border-bottom: 2px solid rgba(255,255,255,0.3);
}

.pitch-box-bottom {
  bottom: 0;
  left: 30%;
  right: 30%;
  height: 15%;
  border-top: 2px solid rgba(255,255,255,0.3);
}

/* Header Layout */
.squad-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: rgba(0,0,0,0.5);
  border-bottom: 1px solid #333;
  position: relative;
  z-index: 5;
  flex-shrink: 0;
}

.squad-header-left {
  display: flex;
  align-items: center;
  gap: 15px;
}

.squad-header-info {
  display: flex;
  flex-direction: column;
}

.squad-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #00ff9c;
}

#teamSelector {
  background: transparent;
  border: 1px solid #333;
  color: #fff;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 16px;
  font-weight: bold;
  min-width: 150px;
}

.squad-formation-text {
  font-size: 12px;
  color: #888;
  margin-top: 2px;
}

.squad-header-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.squad-rating-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #00ff9c;
  color: #000;
  padding: 8px 16px;
  border-radius: 8px;
}

.squad-rating-label {
  font-size: 10px;
  font-weight: bold;
  text-transform: uppercase;
}

.squad-rating-value {
  font-size: 28px;
  font-weight: bold;
  line-height: 1;
}

/* Player Slots - FIFA STYLE */
.player-slots-container {
  position: relative;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 20px 40px 100px 40px;
  z-index: 2;
  overflow-y: auto;
}

.player-slot-row {
  display: flex;
  justify-content: center;
  gap: 40px;
  flex-wrap: wrap;
  margin: 10px 0;
}

/* FIFA Ultimate Team Card Style */
.player-slot {
  width: 85px;
  height: 105px;
  background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
  border: 2px solid #555;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  overflow: hidden;
}

.player-slot:hover {
  border-color: #00ff9c;
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(0,255,156,0.3);
}

.player-slot.occupied {
  border: 2px solid var(--card-gold);
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

.player-slot.drag-over {
  border-color: #00ff9c;
  background: rgba(0,255,156,0.2);
  transform: scale(1.1);
}

.player-slot-position {
  font-size: 10px;
  color: #aaa;
  margin-top: 5px;
  text-transform: uppercase;
  font-weight: bold;
  background: rgba(0,0,0,0.5);
  padding: 2px 6px;
  border-radius: 3px;
  z-index: 3;
}

.player-slot-add {
  font-size: 24px;
  color: #555;
  margin-top: 25px;
}

/* Player Card Small - FIFA Style */
.player-card-small {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  padding: 5px;
}

.player-card-rating {
  position: absolute;
  top: 3px;
  left: 3px;
  background: var(--card-gold);
  color: #000;
  font-size: 11px;
  font-weight: bold;
  padding: 2px 5px;
  border-radius: 3px;
  z-index: 4;
}

.player-card-position {
  position: absolute;
  top: 3px;
  right: 3px;
  background: rgba(0,0,0,0.7);
  color: #fff;
  font-size: 9px;
  padding: 2px 4px;
  border-radius: 3px;
  z-index: 4;
}

.player-card-photo {
  width: 55px;
  height: 55px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--card-gold);
  margin-top: 20px;
  background: #000;
}

.player-card-name {
  font-size: 9px;
  color: #fff;
  margin-top: 3px;
  text-align: center;
  max-width: 75px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-weight: bold;
  text-shadow: 0 1px 2px rgba(0,0,0,0.8);
}

.player-card-stats {
  display: flex;
  gap: 4px;
  margin-top: 2px;
  font-size: 8px;
  color: #aaa;
}

.player-card-remove {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ff4d4d;
  color: white;
  border: none;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 10px;
  cursor: pointer;
  display: none;
  z-index: 10;
}

.player-slot.occupied:hover .player-card-remove {
  display: block;
}

/* Chemistry Line */
.chemistry-line {
  position: absolute;
  height: 2px;
  background: rgba(0,255,156,0.5);
  transform-origin: left center;
  z-index: 1;
  pointer-events: none;
}

/* Bench */
.bench-section {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 90px;
  background: rgba(0,0,0,0.8);
  border-top: 2px solid #333;
  padding: 10px 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  z-index: 5;
}

.bench-label {
  font-size: 12px;
  color: #888;
  text-transform: uppercase;
  writing-mode: vertical-rl;
  text-orientation: mixed;
  transform: rotate(180deg);
}

.bench-slots {
  display: flex;
  gap: 15px;
  flex: 1;
  overflow-x: auto;
  padding: 5px;
}

.bench-slot {
  min-width: 70px;
  height: 75px;
  background: rgba(255,255,255,0.05);
  border: 2px dashed #444;
  border-radius: 6px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: 0.2s;
}

.bench-slot:hover {
  border-color: #00ff9c;
}

.bench-slot.drag-over {
  border-color: #00ff9c;
  background: rgba(0,255,156,0.3);
  transform: scale(1.05);
}

.bench-slot.occupied {
  border-style: solid;
  border-color: var(--card-blue);
  background: rgba(0,0,0,0.6);
}

/* Back Button */
.back-btn-container {
  position: absolute;
  top: 80px;
  left: 15px;
  z-index: 10;
}

.back-btn {
  background: rgba(0,0,0,0.7);
  color: white;
  border: 1px solid #333;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s;
}

.back-btn:hover {
  background: rgba(0,255,156,0.2);
  border-color: #00ff9c;
}

/* Teams Nav */
.teams-nav {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  padding: 0 20px;
}

.teams-nav-tab {
  padding: 10px 20px;
  background: #111827;
  border: 2px solid #333;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}

.teams-nav-tab:hover {
  border-color: #00ff9c;
}

.teams-nav-tab.active {
  background: #00ff9c;
  color: black;
  border-color: #00ff9c;
}

/* ===== MATCH PAGE STYLES ===== */
.matchPage {
  max-width: 1000px;
  margin: 0 auto;
}

.match-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid #333;
  padding-bottom: 10px;
}

.match-tab {
  padding: 10px 20px;
  background: #111827;
  border: 2px solid #333;
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  transition: 0.2s;
  border-bottom: none;
}

.match-tab:hover {
  border-color: #00ff9c;
}

.match-tab.active {
  background: #00ff9c;
  color: black;
  border-color: #00ff9c;
}

.match-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.match-item {
  background: #111827;
  border: 2px solid #333;
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  transition: 0.2s;
  cursor: pointer;
}

.match-item:hover {
  border-color: #00ff9c;
  transform: translateX(5px);
}

.match-item.upcoming {
  border-color: #fbbf24;
  background: rgba(251, 191, 36, 0.05);
}

.match-item.upcoming:hover {
  border-color: #f59e0b;
}

.match-teams {
  display: flex;
  align-items: center;
  gap: 15px;
  flex: 1;
}

.match-team {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.match-team.home {
  justify-content: flex-end;
  text-align: right;
}

.match-team-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #00ff9c;
}

.match-team-name {
  font-weight: bold;
  font-size: 16px;
}

.match-score {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  min-width: 80px;
}

.match-score-value {
  font-size: 32px;
  font-weight: bold;
  color: #00ff9c;
  font-family: monospace;
}

.match-status {
  font-size: 11px;
  color: #888;
  text-transform: uppercase;
  padding: 2px 8px;
  background: rgba(0,0,0,0.5);
  border-radius: 4px;
}

.match-status.upcoming {
  color: #fbbf24;
}

.match-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.match-scorers {
  font-size: 13px;
  color: #aaa;
}

.match-scorers strong {
  color: #00ff9c;
}

.match-assist {
  color: #666;
  font-size: 11px;
}

.match-date {
  font-size: 12px;
  color: #888;
  text-align: center;
  min-width: 80px;
}

/* Match Detail View */
.match-detail {
  background: #111827;
  border-radius: 12px;
  padding: 20px;
}

.match-detail-header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 2px solid #333;
}

.match-detail-teams {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 30px;
  margin-bottom: 20px;
}

.match-detail-team {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.match-detail-team img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 3px solid #00ff9c;
}

.match-detail-score {
  font-size: 48px;
  font-weight: bold;
  color: #00ff9c;
  font-family: monospace;
}

.match-stats {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 20px;
  margin: 20px 0;
  align-items: center;
}

.match-stat-row {
  display: contents;
}

.match-stat-value {
  text-align: center;
  font-weight: bold;
  font-size: 18px;
}

.match-stat-label {
  text-align: center;
  color: #888;
  font-size: 12px;
  text-transform: uppercase;
}

.match-comment-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 2px solid #333;
}

/* Match Form */
.match-form {
  background: #0a0f1f;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.match-form h3 {
  color: #00ff9c;
  margin-bottom: 15px;
}

.match-form-row {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 15px;
  align-items: center;
  margin-bottom: 15px;
}

.match-form-team {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.match-form-vs {
  font-size: 20px;
  font-weight: bold;
  color: #00ff9c;
}

.match-form input, .match-form select {
  padding: 10px;
  font-size: 14px;
}

.match-form-section {
  background: #111827;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.match-form-section-title {
  font-weight: bold;
  color: #00ff9c;
  margin-bottom: 10px;
  font-size: 14px;
}

.scorer-row {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 8px;
  padding: 8px;
  background: #0a0f1f;
  border-radius: 6px;
}

.scorer-row select {
  width: 100px;
}

.scorer-row input {
  flex: 1;
}

.category-selector {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.category-btn {
  padding: 8px 16px;
  background: #1a2233;
  border: 2px solid #333;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.2s;
}

.category-btn:hover {
  border-color: #00ff9c;
}

.category-btn.selected {
  background: #00ff9c;
  color: black;
  border-color: #00ff9c;
}

/* Set Match Button */
.set-match-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #00ff9c;
  color: black;
  padding: 15px 30px;
  border-radius: 50px;
  font-size: 16px;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(0,255,156,0.4);
  z-index: 50;
  border: none;
  cursor: pointer;
  transition: 0.2s;
}

.set-match-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,255,156,0.6);
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #888;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #0a0f1f;
}

::-webkit-scrollbar-thumb {
  background: #333;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #00ff9c;
}

/* Create Match After Save Button */
.create-match-btn {
  background: #00ff9c;
  color: black;
  padding: 15px 30px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  cursor: pointer;
  margin: 20px auto;
  display: block;
  transition: 0.2s;
}

.create-match-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,255,156,0.4);
}

/* Success Message */
.success-message {
  background: rgba(0,255,156,0.1);
  border: 1px solid #00ff9c;
  color: #00ff9c;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  margin: 20px 0;
}

/* ===== TRAIT/BADGE SELECTOR STYLES ===== */
.trait-badge-selector {
  background: #0a0f1f;
  border: 2px solid #333;
  border-radius: 12px;
  padding: 20px;
  margin-top: 15px;
  max-height: 400px;
  overflow-y: auto;
}

.trait-badge-category {
  margin-bottom: 20px;
}

.trait-badge-category h4 {
  color: #00ff9c;
  margin-bottom: 10px;
  font-size: 14px;
  text-transform: uppercase;
}

.trait-badge-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.trait-badge-option {
  padding: 8px 12px;
  background: #1a2233;
  border: 2px solid #333;
  border-radius: 20px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
  user-select: none;
}

.trait-badge-option:hover {
  border-color: #00ff9c;
  background: #252d3d;
}

.trait-badge-option.selected {
  background: #00ff9c;
  color: black;
  border-color: #00ff9c;
  font-weight: bold;
}

.trait-badge-option.selected:hover {
  background: #00cc7d;
}

/* Info tooltip for traits/badges */
.trait-badge-option[title]:hover::after {
  content: attr(title);
  position: absolute;
  background: #000;
  color: #fff;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 11px;
  white-space: nowrap;
  z-index: 100;
  margin-top: -30px;
}

/* VIEWER MODE - Read only styling */
.viewer-mode .player-slot {
  cursor: default !important;
  pointer-events: none !important;
}

.viewer-mode .bench-slot {
  cursor: default !important;
  pointer-events: none !important;
}

.viewer-mode .pool-player {
  cursor: default !important;
  pointer-events: none !important;
}

.viewer-mode .team-list-item {
  cursor: default !important;
}

.viewer-mode .squad-sidebar {
  pointer-events: none !important;
}

.viewer-mode .back-btn {
  display: none !important;
}

/* Ensure viewers can still use team selector */
.viewer-mode #teamSelector {
  pointer-events: auto !important;
  cursor: pointer !important;
}

.viewer-mode .squad-header {
  pointer-events: auto !important;
}
</style>
</head>
<body>

<div id="syncStatus" class="sync-connecting">Connecting...</div>

<header>
  <div style="display: flex; align-items: center; gap: 10px;">
    <span style="font-size: 20px;">‚öΩ</span>
    <span id="viewerDisplay">Ahmed Ghazy</span>
    <span id="editNameBtn">‚úèÔ∏è</span>
  </div>
  <span id="adminBadge"></span>
</header>

<div class="tab-container">
  <div class="tab active" data-tab="listView" onclick="switchMainTab('listView')">List</div>
  <div class="tab" data-tab="teamPage" onclick="switchMainTab('teamPage')">Teams</div>
  <div class="tab" data-tab="matchPage" onclick="switchMainTab('matchPage')">Matches</div>
</div>

<!-- LIST VIEW -->
<div id="listView" class="container">
  <div class="tabs">
    <div class="tab active" data-list="all" onclick="switchList('all')">All-Time</div>
    <div class="tab" data-list="weekly" onclick="switchList('weekly')">Weekly</div>
    <div class="tab" data-list="monthly" onclick="switchList('monthly')">Monthly</div>
  </div>
  <div style="margin-bottom: 10px;" class="admin-only">
    <input id="newName" placeholder="New player name" style="width: 200px;">
    <button onclick="addPlayer()">Add Player</button>
  </div>
  <div class="list-header">
    <div>#</div><div>Name</div><div>Pos</div>
    <div>PAC</div><div>SHO</div><div>PAS</div>
    <div>DRI</div><div>DEF</div><div>PHY</div>
    <div>OVR</div>
    <div>G</div><div>A</div><div>S</div>
    <div>Actions</div>
  </div>
  <div id="rows"></div>
  <div class="commentSection">
    <h3>Comments</h3>
    <div id="comList"></div>
    <textarea id="cinput" placeholder="Write a comment..." oninput="autoGrow(this)"></textarea>
    <button onclick="addComment()">Send</button>
  </div>
</div>

<!-- TEAMS PAGE - VIEWERS CAN SWITCH BETWEEN 2 TEAMS -->
<div id="teamPage" class="teamPage hidden" style="max-width: 100%; padding: 0;">
  
  <!-- Admin Navigation - Hidden for viewers -->
  <div class="teams-nav admin-only" id="teamsNav" style="display: none;">
    <div class="teams-nav-tab active" onclick="switchTeamsView('setup')" id="navSetup">‚öôÔ∏è Setup</div>
    <div class="teams-nav-tab" onclick="switchTeamsView('squads')" id="navSquads">üéØ Squads</div>
  </div>

  <!-- SETUP VIEW - ADMIN ONLY -->
  <div id="setupView" class="setup-container admin-only" style="display: none;">
    <div class="setup-header">
      <h2 class="setup-title">Team Setup</h2>
      <div class="setup-controls">
        <div class="team-count-control">
          <button class="team-count-btn" onclick="changeTeamCount(-1)">‚àí</button>
          <span class="team-count-display" id="teamCountDisplay">2</span>
          <button class="team-count-btn" onclick="changeTeamCount(1)">+</button>
        </div>
        <div class="setup-actions">
          <button onclick="resetTeams()" class="btn-secondary">Reset All</button>
          <button onclick="saveTeamsAndGoToSquads()">Save & Continue ‚Üí</button>
        </div>
      </div>
    </div>

    <div id="setupGrid" class="setup-grid"></div>

    <div class="setup-footer">
      <button onclick="autoGenerateTeams()" class="btn-secondary">üé≤ Auto-Generate Teams</button>
      <button onclick="analyzeAndSuggestFormations()" class="btn-warning">‚ö° Auto-Build Formation</button>
    </div>
  </div>

  <!-- SQUADS VIEW - AVAILABLE TO ALL -->
  <div id="squadsView" style="display: none;">
    <div class="squad-builder-container" id="squadBuilderContainer">
      <!-- Sidebar -->
      <div class="squad-sidebar" id="squadSidebar">
        <!-- Team List Section -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">My Teams</div>
          <div id="teamList" class="team-list-section"></div>
        </div>
        
        <!-- Player Pool - ADMIN ONLY -->
        <div class="sidebar-section pool-container admin-only">
          <div class="pool-header">
            <span class="pool-title">Player Pool</span>
            <span style="font-size: 12px; color: #888;" id="poolCount">0</span>
          </div>
          <input type="text" id="poolSearch" placeholder="Search players..." class="pool-search" oninput="filterPool()">
          <div id="poolList" class="pool-list"></div>
          <div class="pool-hint">
            Drag players to pitch or bench
          </div>
        </div>
        
        <!-- Viewer Hint - VIEWERS ONLY -->
        <div class="sidebar-section viewer-hint-section admin-only" style="display: none;">
          <div>üëÅÔ∏è View-only mode</div>
          <div style="margin-top: 5px;">Select a team from the dropdown above</div>
        </div>
        
        <!-- Admin Controls - Fixed at bottom -->
        <div class="admin-controls-section admin-only">
          <button onclick="deleteCurrentTeam()" class="btn-danger">üóëÔ∏è Delete Team</button>
          <button onclick="clearSquad()">üßπ Clear Squad</button>
          <button onclick="backToSetup()" class="btn-secondary">‚öôÔ∏è Back to Setup</button>
        </div>
      </div>

      <!-- Main Pitch -->
      <div class="squad-main">
        <div class="back-btn-container admin-only">
          <button class="back-btn" onclick="backToSetup()">‚Üê Back to Setup</button>
        </div>
        
        <div class="squad-header">
          <div class="squad-header-left">
            <img id="currentTeamIcon" src="" class="squad-icon" style="display: none;">
            <div class="squad-header-info">
              <select id="teamSelector" onchange="switchTeam(this.value)">
                <option value="">Select Team</option>
              </select>
              <div class="squad-formation-text" id="formationDisplay">Formation ‚Ä¢ 0/11 players</div>
            </div>
          </div>
          <div class="squad-header-right">
            <div class="squad-rating-box">
              <div class="squad-rating-label">OVR</div>
              <div class="squad-rating-value" id="teamOVR">0</div>
            </div>
          </div>
        </div>

        <div class="pitch-lines">
          <div class="pitch-line pitch-center-line"></div>
          <div class="pitch-line pitch-center-circle"></div>
          <div class="pitch-line pitch-box-top"></div>
          <div class="pitch-line pitch-box-bottom"></div>
        </div>

        <div id="playerSlots" class="player-slots-container"></div>

        <div class="bench-section">
          <div class="bench-label">Bench</div>
          <div id="benchSlots" class="bench-slots"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="emptyState" class="viewer-message" style="display: none;">
    <h2>No Teams Yet</h2>
    <p>Check back later for teams.</p>
  </div>
</div>

<!-- MATCHES PAGE -->
<div id="matchPage" class="matchPage hidden container">
  <div class="match-tabs">
    <div class="match-tab active" onclick="switchMatchTab('all')" id="matchTabAll">All Matches</div>
    <div class="match-tab" onclick="switchMatchTab('upcoming')" id="matchTabUpcoming">Upcoming</div>
    <div class="match-tab" onclick="switchMatchTab('past')" id="matchTabPast">Past</div>
  </div>

  <div id="matchList" class="match-list"></div>

  <!-- Match Detail View -->
  <div id="matchDetailView" class="match-detail hidden">
    <button onclick="backToMatchList()" style="margin-bottom: 15px;">‚Üê Back to Matches</button>
    
    <div class="match-detail-header">
      <div class="match-detail-teams">
        <div class="match-detail-team">
          <img id="detailHomeIcon" src="">
          <div id="detailHomeName" style="font-weight: bold; font-size: 20px;"></div>
        </div>
        <div class="match-detail-score" id="detailScore">0 - 0</div>
        <div class="match-detail-team">
          <img id="detailAwayIcon" src="">
          <div id="detailAwayName" style="font-weight: bold; font-size: 20px;"></div>
        </div>
      </div>
      <div id="detailStatus" class="match-status" style="display: inline-block;">Upcoming</div>
      <div id="detailCategory" style="margin-top: 10px; color: #888; font-size: 12px;"></div>
    </div>

    <div class="match-stats" id="matchStats"></div>

    <div class="match-comment-section">
      <h3>Match Comments</h3>
      <div id="matchComments"></div>
      <textarea id="matchCommentInput" placeholder="Write a comment..." oninput="autoGrow(this)" style="margin-top: 10px;"></textarea>
      <button onclick="addMatchComment()" style="margin-top: 10px;">Send</button>
    </div>

    <div class="admin-only" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #333;">
      <h3>Admin Controls</h3>
      <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
        <button onclick="editMatch()">‚úèÔ∏è Edit Match</button>
        <button onclick="deleteMatch()" class="btn-danger">üóëÔ∏è Delete</button>
        <button onclick="toggleMatchStatus()" id="statusToggleBtn">Mark as Played</button>
      </div>
    </div>
  </div>

  <!-- Create/Edit Match Form -->
  <div id="matchForm" class="match-form hidden admin-only">
    <h3 id="matchFormTitle">Set New Match</h3>
    
    <div class="match-form-section">
      <div class="match-form-section-title">Teams</div>
      <div class="match-form-row">
        <div class="match-form-team">
          <label>Home Team</label>
          <select id="matchHomeTeam"></select>
        </div>
        <div class="match-form-vs">VS</div>
        <div class="match-form-team">
          <label>Away Team</label>
          <select id="matchAwayTeam"></select>
        </div>
      </div>
    </div>

    <div class="match-form-section">
      <div class="match-form-section-title">Category</div>
      <div class="category-selector">
        <button class="category-btn selected" onclick="selectCategory('league')" data-cat="league">League</button>
        <button class="category-btn" onclick="selectCategory('cup')" data-cat="cup">Cup</button>
        <button class="category-btn" onclick="selectCategory('friendly')" data-cat="friendly">Friendly</button>
        <button class="category-btn" onclick="selectCategory('final')" data-cat="final">Final</button>
      </div>
    </div>

    <div class="match-form-section">
      <div class="match-form-section-title">Status</div>
      <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" id="matchIsUpcoming" checked onchange="toggleMatchFormMode()">
        <span>This is an upcoming match</span>
      </label>
    </div>

    <div id="scoreSection" style="display: none;">
      <div class="match-form-section">
        <div class="match-form-section-title">Score</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>Home Score</label>
            <input type="number" id="matchHomeScore" value="0" min="0">
          </div>
          <div>
            <label>Away Score</label>
            <input type="number" id="matchAwayScore" value="0" min="0">
          </div>
        </div>
      </div>

      <div class="match-form-section">
        <div class="match-form-section-title">Scorers & Assists</div>
        <div id="scorersList">
          <div class="scorer-row">
            <select class="scorer-team">
              <option value="home">Home</option>
              <option value="away">Away</option>
            </select>
            <input type="text" class="scorer-name" placeholder="Scorer name">
            <input type="text" class="assist-name" placeholder="Assist by (optional)">
            <button onclick="this.parentElement.remove()" class="btn-danger" style="padding: 5px 10px;">√ó</button>
          </div>
        </div>
        <button onclick="addScorerRow()" class="btn-secondary" style="margin-top: 10px;">+ Add Scorer</button>
      </div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button onclick="saveMatch()">üíæ Save Match</button>
      <button onclick="cancelMatchForm()" class="btn-secondary">Cancel</button>
    </div>
  </div>

  <button class="set-match-btn admin-only" onclick="showMatchForm()">+ Set Match</button>
</div>

<!-- STATS VIEW -->
<div id="statsView" class="statPage hidden container">
  <button onclick="backToList()">‚¨Ö Back to List</button>
  
  <div style="display: grid; grid-template-columns: 200px 1fr; gap: 30px; margin-top: 20px;">
    <div>
      <div class="photoWrapper">
        <img id="playerPhoto" class="photo" src="" alt="Player Photo">
        <button id="removePhotoBtn" onclick="removePhoto()" class="hidden admin-only">√ó</button>
      </div>
      <div class="admin-only" style="margin-top: 10px;">
        <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
        <button onclick="document.getElementById('photoInput').click()">Upload Photo</button>
      </div>
    </div>
    
    <div>
      <h2 id="statName" style="margin-top: 0;">Player (ST)</h2>
      <div id="statGrid" class="statGrid"></div>
      
      <h3>Summary</h3>
      <textarea id="statSummary" oninput="updateSummary()" rows="4" placeholder="Player summary..."></textarea>
      
      <!-- NEW: Trait Selector -->
      <div style="margin-top: 20px;">
        <h3>Traits (Select as many as apply)</h3>
        <div id="traitSelector" class="trait-badge-selector">
          <div class="trait-badge-category">
            <h4>Attacking</h4>
            <div class="trait-badge-grid" id="attackingTraits"></div>
          </div>
          <div class="trait-badge-category">
            <h4>Technical</h4>
            <div class="trait-badge-grid" id="technicalTraits"></div>
          </div>
          <div class="trait-badge-category">
            <h4>Physical</h4>
            <div class="trait-badge-grid" id="physicalTraits"></div>
          </div>
          <div class="trait-badge-category">
            <h4>Mental</h4>
            <div class="trait-badge-grid" id="mentalTraits"></div>
          </div>
        </div>
      </div>
      
      <!-- NEW: Badge Selector -->
      <div style="margin-top: 20px;">
        <h3>Badges (Select achievements)</h3>
        <div id="badgeSelector" class="trait-badge-selector">
          <div class="trait-badge-category">
            <h4>Scoring</h4>
            <div class="trait-badge-grid" id="scoringBadges"></div>
          </div>
          <div class="trait-badge-category">
            <h4>Playmaking</h4>
            <div class="trait-badge-grid" id="playmakingBadges"></div>
          </div>
          <div class="trait-badge-category">
            <h4>Defensive</h4>
            <div class="trait-badge-grid" id="defensiveBadges"></div>
          </div>
          <div class="trait-badge-category">
            <h4>Special</h4>
            <div class="trait-badge-grid" id="specialBadges"></div>
          </div>
        </div>
      </div>
      
      <button onclick="saveStatChanges()" class="admin-only" style="margin-top: 20px;">Save Changes</button>
    </div>
  </div>

  <div class="displayedTraitsBadges" style="margin-top: 20px;">
    <strong>Traits:</strong> <span id="dispTraits"></span><br>
    <strong>Badges:</strong> <span id="dispBadges"></span>
  </div>

  <div class="commentSection" style="margin-top: 20px;">
    <h3>Player Comments</h3>
    <div id="statComList"></div>
    <textarea id="statCInput" placeholder="Write a comment..." oninput="autoGrow(this)"></textarea>
    <button onclick="addStatComment()">Send</button>
  </div>
</div>

<script>
/* ===== FIREBASE CONFIGURATION ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCn4KPH12laahx8vegbXJkwrgTIB_wqzA4",
  authDomain: "grade6b-fc.firebaseapp.com",
  databaseURL: "https://grade6b-fc-default-rtdb.firebaseio.com",
  projectId: "grade6b-fc",
  storageBucket: "grade6b-fc.firebasestorage.app",
  messagingSenderId: "352914009628",
  appId: "1:352914009628:web:fa6995f048894aec0339d9"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* ===== ENHANCED TRAITS & BADGES DATABASE ===== */
const traitsDatabase = {
  attacking: [
    { id: 'master_striker', name: 'Master Striker', desc: 'Lethal finisher with exceptional goal-scoring instinct' },
    { id: 'clinical_finisher', name: 'Clinical Finisher', desc: 'Rarely misses clear chances in front of goal' },
    { id: 'poacher', name: 'Poacher', desc: 'Always in the right place at the right time in the box' },
    { id: 'long_shot_taker', name: 'Long Shot Taker', desc: 'Dangerous from outside the penalty area' },
    { id: 'aerial_threat', name: 'Aerial Threat', desc: 'Dominant in the air and dangerous on headers' }
  ],
  technical: [
    { id: 'dribbler', name: 'Dribbler', desc: 'Exceptional ball control and ability to beat defenders' },
    { id: 'playmaker', name: 'Playmaker', desc: 'Creates chances and dictates tempo for the team' },
    { id: 'visionary', name: 'Visionary', desc: 'Sees passes others cannot and unlocks defenses' },
    { id: 'free_kick_specialist', name: 'Free Kick Specialist', desc: 'Deadly accuracy from set pieces' },
    { id: 'technical_dribbler', name: 'Technical', desc: 'Superior first touch and ball manipulation' }
  ],
  physical: [
    { id: 'speedster', name: 'Speedster', desc: 'Blistering pace that terrifies defenders' },
    { id: 'powerhouse', name: 'Powerhouse', desc: 'Strength and physical dominance over opponents' },
    { id: 'engine', name: 'Engine', desc: 'Never stops running and covers every blade of grass' },
    { id: 'agile', name: 'Agile', desc: 'Quick changes of direction and rapid acceleration' },
    { id: 'tough_tackler', name: 'Tough Tackler', desc: 'Wins physical duels and imposes himself' }
  ],
  mental: [
    { id: 'leader', name: 'Leader', desc: 'Commands respect and organizes the team' },
    { id: 'clutch_performer', name: 'Clutch Performer', desc: 'Delivers in the most important moments' },
    { id: 'team_player', name: 'Team Player', desc: 'Selfless and always puts the team first' },
    { id: 'composed', name: 'Composed', desc: 'Never panics under pressure' },
    { id: 'fighter', name: 'Fighter', desc: 'Never gives up and battles until the final whistle' }
  ]
};

const badgesDatabase = {
  scoring: [
    { id: 'hat_trick_hero', name: 'Hat-Trick Hero', desc: 'Scored 3+ goals in a single match' },
    { id: 'top_scorer', name: 'Top Scorer', desc: 'Leading goal scorer in competition' },
    { id: 'golden_boot', name: 'Golden Boot', desc: 'Most goals in the season' },
    { id: 'free_kick_king', name: 'Free Kick King', desc: 'Scored 5+ goals from free kicks' },
    { id: 'penalty_specialist', name: 'Penalty Specialist', desc: 'Never missed a penalty' }
  ],
  playmaking: [
    { id: 'assist_king', name: 'Assist King', desc: 'Most assists in the team' },
    { id: 'playmaker_award', name: 'Playmaker Award', desc: 'Created the most chances' },
    { id: 'pass_master', name: 'Pass Master', desc: '90%+ pass accuracy over 10+ games' }
  ],
  defensive: [
    { id: 'iron_wall', name: 'Iron Wall', desc: '5+ consecutive clean sheets' },
    { id: 'tackle_machine', name: 'Tackle Machine', desc: 'Most tackles won' },
    { id: 'interceptor', name: 'Interceptor', desc: 'Most interceptions per game' },
    { id: 'golden_glove', name: 'Golden Glove', desc: 'Best goalkeeper award' }
  ],
  special: [
    { id: 'captain', name: 'Captain', desc: 'Team captain' },
    { id: 'iron_man', name: 'Iron Man', desc: 'Played every minute of the season' },
    { id: 'rising_star', name: 'Rising Star', desc: 'Most improved player' },
    { id: 'fan_favorite', name: 'Fan Favorite', desc: 'Voted by fans as favorite player' },
    { id: 'derby_hero', name: 'Derby Hero', desc: 'Decisive performance in derby match' }
  ]
};

/* ===== GLOBAL VARIABLES ===== */
let isAdmin = false;
let viewer = '';
let teams = [];
let currentTeamId = null;
let activeList = 'all';
let draggedPlayer = null;
let tempTeams = [];
let setupTeamCount = 2;
let currentMatchId = null;
let activeMatchTab = 'all';
let selectedMatchCategory = 'league';
let editingMatch = null;
let isOnline = false;
let lastSyncTime = 0;

const availablePositions = ["GK", "CB", "LB", "RB", "LWB", "RWB", "CM", "CDM", "CAM", "LM", "RM", "LW", "RW", "ST", "CF"];

let lists = {all:[],weekly:[],monthly:[]};
let comments = {all:[],weekly:[],monthly:[]};
let playerComments = {};
let currentPlayer = null;
let matches = [];

/* ===== SYNC STATUS ===== */
function updateSyncStatus(status, message) {
  const el = document.getElementById('syncStatus');
  el.className = status;
  el.innerText = message;
}

/* ===== AUTO RESET FUNCTIONS - AUTOMATIC WEEKLY/MONTHLY ===== */
function getWeekNumber(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

function checkAndResetPeriodicLists() {
  const now = new Date();
  const currentWeek = getWeekNumber(now);
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  const lastResetWeek = parseInt(localStorage.getItem('lastResetWeek') || '0');
  const lastResetMonth = parseInt(localStorage.getItem('lastResetMonth') || '-1');
  const lastResetYear = parseInt(localStorage.getItem('lastResetYear') || '0');
  
  let needsSave = false;
  
  if (currentWeek !== lastResetWeek || currentYear !== lastResetYear) {
    console.log('Auto-resetting weekly list...');
    resetWeeklyList();
    localStorage.setItem('lastResetWeek', currentWeek.toString());
    localStorage.setItem('lastResetYear', currentYear.toString());
    needsSave = true;
  }
  
  if (currentMonth !== lastResetMonth || currentYear !== lastResetYear) {
    console.log('Auto-resetting monthly list...');
    resetMonthlyList();
    localStorage.setItem('lastResetMonth', currentMonth.toString());
    localStorage.setItem('lastResetYear', currentYear.toString());
    needsSave = true;
  }
  
  return needsSave;
}

function resetWeeklyList() {
  if (!lists.weekly) lists.weekly = [];
  lists.weekly = lists.weekly.map(player => ({
    ...player,
    weekly: {G: 0, A: 0, S: 0}
  }));
  if (!comments.weekly) comments.weekly = [];
  comments.weekly = [];
  console.log('Weekly list reset complete');
}

function resetMonthlyList() {
  if (!lists.monthly) lists.monthly = [];
  lists.monthly = lists.monthly.map(player => ({
    ...player,
    monthly: {G: 0, A: 0, S: 0}
  }));
  if (!comments.monthly) comments.monthly = [];
  comments.monthly = [];
  console.log('Monthly list reset complete');
}

/* ===== FIREBASE SYNC FUNCTIONS ===== */
function initFirebaseSync() {
  updateSyncStatus('sync-connecting', 'Connecting...');
  
  // Check and auto-reset weekly/monthly if needed
  const needsResetSave = checkAndResetPeriodicLists();
  
  // Listen for data changes
  database.ref('grade6bfc').on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      // Update local data
      if (data.lists) lists = data.lists;
      if (data.comments) comments = data.comments;
      if (data.playerComments) playerComments = data.playerComments;
      if (data.teams) {
        teams = data.teams;
        teams.forEach(team => {
          if(!team.customFormation) team.customFormation = [];
          if(!team.maxPlayers) team.maxPlayers = team.customFormation.length || 11;
        });
      }
      if (data.matches) matches = data.matches;
      
      lastSyncTime = Date.now();
      isOnline = true;
      updateSyncStatus('sync-connected', '‚óè Live');
      
      // Refresh UI
      renderList();
      renderComments();
      if (document.getElementById('teamPage').classList.contains('hidden') === false) {
        initTeamPage();
      }
      if (document.getElementById('matchPage').classList.contains('hidden') === false) {
        initMatchPage();
      }
    } else {
      // First time - save initial data
      if (needsResetSave) {
        saveToFirebase();
      } else {
        saveToFirebase();
      }
    }
  }, (error) => {
    console.error('Firebase error:', error);
    isOnline = false;
    updateSyncStatus('sync-error', '‚ö† Offline');
    initLocalData();
  });
  
  // Connection state monitoring
  database.ref('.info/connected').on('value', (snap) => {
    if (snap.val() === true) {
      isOnline = true;
    } else {
      isOnline = false;
      updateSyncStatus('sync-error', '‚ö† Offline');
    }
  });
}

function saveToFirebase() {
  if (!isOnline) {
    localStorage.setItem("lists", JSON.stringify(lists));
    localStorage.setItem("comments", JSON.stringify(comments));
    localStorage.setItem("playerComments", JSON.stringify(playerComments));
    localStorage.setItem("teams", JSON.stringify(teams));
    localStorage.setItem("matches", JSON.stringify(matches));
    return;
  }
  
  const now = new Date();
  
  const data = {
    lists: lists,
    comments: comments,
    playerComments: playerComments,
    teams: teams,
    matches: matches,
    resetTimes: {
      weekly: {
        week: getWeekNumber(now),
        year: now.getFullYear(),
        timestamp: Date.now()
      },
      monthly: {
        month: now.getMonth(),
        year: now.getFullYear(),
        timestamp: Date.now()
      }
    },
    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
    updatedBy: viewer
  };
  
  database.ref('grade6bfc').set(data);
  updateSyncStatus('sync-connected', '‚óè Synced');
}

function initLocalData() {
  const storedLists = localStorage.getItem("lists");
  const storedComments = localStorage.getItem("comments");
  const storedPlayerComments = localStorage.getItem("playerComments");
  const storedTeams = localStorage.getItem("teams");
  const storedMatches = localStorage.getItem("matches");
  
  if(storedLists) lists = JSON.parse(storedLists);
  if(storedComments) comments = JSON.parse(storedComments);
  if(storedPlayerComments) playerComments = JSON.parse(storedPlayerComments);
  if(storedTeams) {
    teams = JSON.parse(storedTeams);
    teams.forEach(team => {
      if(!team.customFormation) team.customFormation = [];
      if(!team.maxPlayers) team.maxPlayers = team.customFormation.length || 11;
    });
    setupTeamCount = teams.length > 0 ? teams.length : 2;
  }
  if(storedMatches) matches = JSON.parse(storedMatches);
  
  renderList();
  renderComments();
}

/* ===== INITIALIZATION ===== */
function initAuth() {
  let access = false;
  while(!access) {
    const code = prompt("Enter viewer code:");
    if(code === "Grade6B") {
      access = true;
    } else {
      alert("Wrong code!");
    }
  }
  
  viewer = localStorage.getItem("viewerName");
  if(!viewer) {
    viewer = prompt("Enter your display name:");
    if(viewer) localStorage.setItem("viewerName", viewer);
  }
  
  const viewerDisplay = document.getElementById("viewerDisplay");
  viewerDisplay.innerText = viewer || "Guest";
  
  // Setup edit name button - NOW AVAILABLE TO EVERYONE
  const editBtn = document.getElementById("editNameBtn");
  editBtn.onclick = function() {
    const newName = prompt("Change display name:", viewer);
    if(newName && newName.trim()) {
      viewer = newName.trim();
      localStorage.setItem("viewerName", viewer);
      viewerDisplay.innerText = viewer;
    }
  };
  
  const adminCode = prompt("Operator code (optional):");
  isAdmin = (adminCode === "Ahmed GhazyA2211");
  
  if(isAdmin) {
    document.getElementById("adminBadge").innerText = "üëë Operator";
    document.body.classList.add("admin");
    editBtn.style.display = "inline";
  } else {
    document.body.classList.add("viewer");
    // Edit button is now visible to viewers too
    editBtn.style.display = "inline";
  }
  
  initFirebaseSync();
}

function autoGrow(t) {
  t.style.height = "auto";
  t.style.height = t.scrollHeight + "px";
}

function ovr(p) {
  if(!p || !p.stats) return 0;
  const s = p.stats;
  return Math.round((s.PAC + s.SHO + s.PAS + s.DRI + s.DEF + s.PHY) / 6);
}

/* ===== TABS ===== */
function switchMainTab(tab) {
  document.getElementById("listView").classList.add("hidden");
  document.getElementById("teamPage").classList.add("hidden");
  document.getElementById("matchPage").classList.add("hidden");
  document.getElementById("statsView").classList.add("hidden");
  
  document.querySelectorAll(".tab-container .tab").forEach(t => t.classList.remove("active"));
  
  if(tab !== 'statsView') {
    const tabEl = document.querySelector(`.tab-container .tab[data-tab='${tab}']`);
    if(tabEl) tabEl.classList.add("active");
  }
  
  const viewEl = document.getElementById(tab);
  if(viewEl) viewEl.classList.remove("hidden");
  
  if(tab === 'teamPage') initTeamPage();
  if(tab === 'matchPage') initMatchPage();
}

function switchList(list) {
  activeList = list;
  document.querySelectorAll("#listView .tabs .tab").forEach(t => t.classList.remove("active"));
  const activeTab = document.querySelector(`#listView .tabs .tab[data-list='${list}']`);
  if(activeTab) activeTab.classList.add("active");
  renderList();
  renderComments();
}

/* ===== PLAYER LIST ===== */
function renderList() {
  const rows = document.getElementById("rows");
  rows.innerHTML = "";
  
  if (!lists[activeList]) lists[activeList] = [];
  
  lists[activeList].forEach((p, i) => {
    if(!p[activeList]) p[activeList] = {G:0, A:0, S:0};
    const G = p[activeList].G || 0;
    const A = p[activeList].A || 0;
    const S = p[activeList].S || 0;
    const o = ovr(p);
    rows.innerHTML += `
      <div class="row">
        <div>${i+1}</div>
        <input value="${p.name}" ${!isAdmin ? "readonly" : ""} onchange="updatePlayerName(${i}, this.value)">
        <select ${!isAdmin ? "disabled" : ""} onchange="updatePlayerPos(${i}, this.value)">
          ${availablePositions.map(x => `<option ${x === p.pos ? "selected" : ""}>${x}</option>`).join("")}
        </select>
        ${["PAC","SHO","PAS","DRI","DEF","PHY"].map(s => `<input type="number" value="${p.stats[s]}" max="99" ${!isAdmin ? "readonly" : ""} onchange="updatePlayerStat(${i}, '${s}', this.value)">`).join("")}
        <div style="font-weight:bold; color:${o >= 80 ? '#00ff9c' : o >= 60 ? '#fbbf24' : '#888'}">${o}</div>
        <input type="number" value="${G}" ${!isAdmin ? "readonly" : ""} onchange="updatePlayerGA(${i}, 'G', this.value)">
        <input type="number" value="${A}" ${!isAdmin ? "readonly" : ""} onchange="updatePlayerGA(${i}, 'A', this.value)">
        <input type="number" value="${S}" ${!isAdmin ? "readonly" : ""} onchange="updatePlayerGA(${i}, 'S', this.value)">
        <div>
          <span class="icon" onclick="openStats(${i})" title="View Stats">üëÅÔ∏è</span>
          ${isAdmin ? `<span class="icon" onclick="moveUp(${i})" title="Move Up">‚¨ÜÔ∏è</span><span class="icon" onclick="moveDown(${i})" title="Move Down">‚¨áÔ∏è</span><span class="icon delete-btn" onclick="delPlayer(${i})" title="Delete">üóëÔ∏è</span>` : ""}
        </div>
      </div>`;
  });
}

function updatePlayerName(i, value) {
  if(!isAdmin) return;
  lists[activeList][i].name = value;
  saveToFirebase();
  renderList();
}

function updatePlayerPos(i, value) {
  if(!isAdmin) return;
  lists[activeList][i].pos = value;
  saveToFirebase();
  renderList();
}

function updatePlayerStat(i, stat, value) {
  if(!isAdmin) return;
  lists[activeList][i].stats[stat] = Math.min(99, +value);
  saveToFirebase();
  renderList();
}

function updatePlayerGA(i, type, value) {
  if(!isAdmin) return;
  lists[activeList][i][activeList][type] = Math.min(99, +value);
  saveToFirebase();
  renderList();
}

function addPlayer() {
  if(!isAdmin) return;
  const name = document.getElementById("newName").value.trim();
  if(!name) return;
  const newPlayer = {
    id: Date.now() + Math.random(),
    name: name,
    pos: "ST",
    stats: {PAC:50, SHO:50, PAS:50, DRI:50, DEF:50, PHY:50},
    [activeList]: {G:0, A:0, S:0},
    summary: "",
    traits: [],
    badges: [],
    photo: ""
  };
  lists[activeList].push(newPlayer);
  document.getElementById("newName").value = "";
  saveToFirebase();
  renderList();
}

function delPlayer(i) {
  if(!isAdmin) return;
  if(!confirm("Delete this player?")) return;
  lists[activeList].splice(i, 1);
  saveToFirebase();
  renderList();
}

function moveUp(i) {
  if(!isAdmin || i === 0) return;
  [lists[activeList][i], lists[activeList][i-1]] = [lists[activeList][i-1], lists[activeList][i]];
  saveToFirebase();
  renderList();
}

function moveDown(i) {
  if(!isAdmin || i === lists[activeList].length - 1) return;
  [lists[activeList][i], lists[activeList][i+1]] = [lists[activeList][i+1], lists[activeList][i]];
  saveToFirebase();
  renderList();
}

/* ===== STATS PAGE WITH ENHANCED TRAITS & BADGES ===== */
function openStats(i) {
  currentPlayer = i;
  const p = lists[activeList][i];
  if(!p) return;
  
  document.getElementById("listView").classList.add("hidden");
  document.getElementById("statsView").classList.remove("hidden");
  document.querySelectorAll(".tab-container .tab").forEach(t => t.classList.remove("active"));
  
  document.getElementById("statName").innerText = p.name + " (" + p.pos + ")";
  document.getElementById("playerPhoto").src = p.photo || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%23111827' width='150' height='150'/%3E%3Ctext fill='%23333' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='50'%3E‚öΩ%3C/text%3E%3C/svg%3E";
  
  const rm = document.getElementById("removePhotoBtn");
  if(p.photo && isAdmin) rm.classList.remove("hidden");
  else rm.classList.add("hidden");
  
  document.getElementById("statSummary").value = p.summary || "";
  document.getElementById("statSummary").readOnly = !isAdmin;
  
  renderStatGrid(p);
  renderTraitSelector(p);
  renderBadgeSelector(p);
  renderDisplayedTraitsBadges(p);
  renderStatComments(p.id);
}

function backToList() {
  document.getElementById("statsView").classList.add("hidden");
  document.getElementById("listView").classList.remove("hidden");
  document.querySelector(`.tab-container .tab[data-tab='listView']`).classList.add("active");
  currentPlayer = null;
}

function handlePhotoUpload(input) {
  if(!isAdmin || currentPlayer === null) return;
  const file = input.files[0];
  if(!file) return;
  if(file.size > 2*1024*1024) {
    alert("Image too large! Max 2MB");
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    lists[activeList][currentPlayer].photo = e.target.result;
    saveToFirebase();
    openStats(currentPlayer);
  };
  reader.readAsDataURL(file);
}

function removePhoto() {
  if(!isAdmin || currentPlayer === null) return;
  lists[activeList][currentPlayer].photo = "";
  saveToFirebase();
  openStats(currentPlayer);
}

function renderStatGrid(p) {
  const grid = document.getElementById("statGrid");
  grid.innerHTML = "";
  for(let s in p.stats) {
    const val = p.stats[s];
    const color = val >= 80 ? '#00ff9c' : val >= 60 ? '#fbbf24' : '#888';
    if(isAdmin) {
      grid.innerHTML += `<div class="statBox"><strong>${s}</strong><br><input type="number" value="${val}" max="99" min="0" onchange="updateStat('${s}', this.value)" style="color:${color}; width: 60px; text-align: center; font-size: 18px; font-weight: bold; background: #020617; border: 1px solid #333; border-radius: 4px; padding: 5px;"></div>`;
    } else {
      grid.innerHTML += `<div class="statBox"><strong>${s}</strong><br><span style="color:${color}; font-size: 1.5em; font-weight: bold;">${val}</span></div>`;
    }
  }
}

function updateStat(stat, value) {
  if(!isAdmin || currentPlayer === null) return;
  lists[activeList][currentPlayer].stats[stat] = Math.min(99, Math.max(0, parseInt(value) || 0));
  saveToFirebase();
  renderStatGrid(lists[activeList][currentPlayer]);
}

function updateSummary() {
  if(!isAdmin || currentPlayer === null) return;
  lists[activeList][currentPlayer].summary = document.getElementById("statSummary").value;
}

/* ===== NEW: RENDER TRAIT SELECTOR ===== */
function renderTraitSelector(p) {
  if (!p.traits) p.traits = [];
  
  // Attacking
  const attackingContainer = document.getElementById('attackingTraits');
  attackingContainer.innerHTML = traitsDatabase.attacking.map(trait => `
    <div class="trait-badge-option ${p.traits.includes(trait.id) ? 'selected' : ''} ${!isAdmin && !p.traits.includes(trait.id) ? 'disabled' : ''}" 
         onclick="${isAdmin ? `toggleTrait('${trait.id}')` : ''}" 
         title="${trait.desc}">
      ${trait.name}
    </div>
  `).join('');
  
  // Technical
  const technicalContainer = document.getElementById('technicalTraits');
  technicalContainer.innerHTML = traitsDatabase.technical.map(trait => `
    <div class="trait-badge-option ${p.traits.includes(trait.id) ? 'selected' : ''} ${!isAdmin && !p.traits.includes(trait.id) ? 'disabled' : ''}" 
         onclick="${isAdmin ? `toggleTrait('${trait.id}')` : ''}" 
         title="${trait.desc}">
      ${trait.name}
    </div>
  `).join('');
  
  // Physical
  const physicalContainer = document.getElementById('physicalTraits');
  physicalContainer.innerHTML = traitsDatabase.physical.map(trait => `
    <div class="trait-badge-option ${p.traits.includes(trait.id) ? 'selected' : ''} ${!isAdmin && !p.traits.includes(trait.id) ? 'disabled' : ''}" 
         onclick="${isAdmin ? `toggleTrait('${trait.id}')` : ''}" 
         title="${trait.desc}">
      ${trait.name}
    </div>
  `).join('');
  
  // Mental
  const mentalContainer = document.getElementById('mentalTraits');
  mentalContainer.innerHTML = traitsDatabase.mental.map(trait => `
    <div class="trait-badge-option ${p.traits.includes(trait.id) ? 'selected' : ''} ${!isAdmin && !p.traits.includes(trait.id) ? 'disabled' : ''}" 
         onclick="${isAdmin ? `toggleTrait('${trait.id}')` : ''}" 
         title="${trait.desc}">
      ${trait.name}
    </div>
  `).join('');
}

function toggleTrait(traitId) {
  if(!isAdmin || currentPlayer === null) return;
  
  const p = lists[activeList][currentPlayer];
  if (!p.traits) p.traits = [];
  
  // REMOVED: No limit on traits - can select unlimited
  if (p.traits.includes(traitId)) {
    p.traits = p.traits.filter(id => id !== traitId);
  } else {
    p.traits.push(traitId);
  }
  
  saveToFirebase();
  renderTraitSelector(p);
  renderDisplayedTraitsBadges(p);
}

/* ===== NEW: RENDER BADGE SELECTOR ===== */
function renderBadgeSelector(p) {
  if (!p.badges) p.badges = [];
  
  // Scoring
  const scoringContainer = document.getElementById('scoringBadges');
  scoringContainer.innerHTML = badgesDatabase.scoring.map(badge => `
    <div class="trait-badge-option ${p.badges.includes(badge.id) ? 'selected' : ''} ${!isAdmin && !p.badges.includes(badge.id) ? 'disabled' : ''}" 
         onclick="${isAdmin ? `toggleBadge('${badge.id}')` : ''}" 
         title="${badge.desc}">
      ${badge.name}
    </div>
  `).join('');
  
  // Playmaking
  const playmakingContainer = document.getElementById('playmakingBadges');
  playmakingContainer.innerHTML = badgesDatabase.playmaking.map(badge => `
    <div class="trait-badge-option ${p.badges.includes(badge.id) ? 'selected' : ''} ${!isAdmin && !p.badges.includes(badge.id) ? 'disabled' : ''}" 
         onclick="${isAdmin ? `toggleBadge('${badge.id}')` : ''}" 
         title="${badge.desc}">
      ${badge.name}
    </div>
  `).join('');
  
  // Defensive
  const defensiveContainer = document.getElementById('defensiveBadges');
  defensiveContainer.innerHTML = badgesDatabase.defensive.map(badge => `
    <div class="trait-badge-option ${p.badges.includes(badge.id) ? 'selected' : ''} ${!isAdmin && !p.badges.includes(badge.id) ? 'disabled' : ''}" 
         onclick="${isAdmin ? `toggleBadge('${badge.id}')` : ''}" 
         title="${badge.desc}">
      ${badge.name}
    </div>
  `).join('');
  
  // Special
  const specialContainer = document.getElementById('specialBadges');
  specialContainer.innerHTML = badgesDatabase.special.map(badge => `
    <div class="trait-badge-option ${p.badges.includes(badge.id) ? 'selected' : ''} ${!isAdmin && !p.badges.includes(badge.id) ? 'disabled' : ''}" 
         onclick="${isAdmin ? `toggleBadge('${badge.id}')` : ''}" 
         title="${badge.desc}">
      ${badge.name}
    </div>
  `).join('');
}

function toggleBadge(badgeId) {
  if(!isAdmin || currentPlayer === null) return;
  
  const p = lists[activeList][currentPlayer];
  if (!p.badges) p.badges = [];
  
  // REMOVED: No limit on badges - can select unlimited
  if (p.badges.includes(badgeId)) {
    p.badges = p.badges.filter(id => id !== badgeId);
  } else {
    p.badges.push(badgeId);
  }
  
  saveToFirebase();
  renderBadgeSelector(p);
  renderDisplayedTraitsBadges(p);
}

function saveStatChanges() {
  if(!isAdmin) return;
  updateSummary();
  saveToFirebase();
  renderList();
  backToList();
}

function renderDisplayedTraitsBadges(p) {
  if(!p) p = lists[activeList][currentPlayer];
  if(!p) return;
  
  // Get trait names from IDs
  const allTraits = [...traitsDatabase.attacking, ...traitsDatabase.technical, ...traitsDatabase.physical, ...traitsDatabase.mental];
  const traitNames = (p.traits || []).map(id => {
    const trait = allTraits.find(t => t.id === id);
    return trait ? trait.name : id;
  });
  
  // Get badge names from IDs
  const allBadges = [...badgesDatabase.scoring, ...badgesDatabase.playmaking, ...badgesDatabase.defensive, ...badgesDatabase.special];
  const badgeNames = (p.badges || []).map(id => {
    const badge = allBadges.find(b => b.id === id);
    return badge ? badge.name : id;
  });
  
  document.getElementById("dispTraits").innerText = traitNames.join(", ") || "None";
  document.getElementById("dispBadges").innerHTML = badgeNames.map(name => `<span class="badgeIcon">${name}</span>`).join(" ") || "None";
}

/* ===== COMMENTS ===== */
function renderComments() {
  const comList = document.getElementById("comList");
  comList.innerHTML = "";
  const cm = comments[activeList] || [];
  cm.slice().reverse().forEach((c, idx) => {
    const realIdx = cm.length - 1 - idx;
    const likes = c.likes || [];
    const dislikes = c.dislikes || [];
    comList.innerHTML += `
      <div class="comment">
        <strong style="color:#00ff9c">${c.user}:</strong> ${c.text}
        <div class="comment-actions">
          <span class="comment-btn ${likes.includes(viewer) ? 'liked' : ''}" onclick="likeComment(${realIdx})">üëç ${likes.length}</span>
          <span class="comment-btn ${dislikes.includes(viewer) ? 'disliked' : ''}" onclick="dislikeComment(${realIdx})">üëé ${dislikes.length}</span>
          ${c.user === viewer ? `<span class="comment-btn" onclick="deleteComment(${realIdx})" style="color:#ff4d4d">üóëÔ∏è</span>` : ""}
        </div>
      </div>`;
  });
}

function addComment() {
  const input = document.getElementById("cinput");
  if(!input.value.trim()) return;
  if(!comments[activeList]) comments[activeList] = [];
  comments[activeList].push({
    user: viewer,
    text: input.value,
    time: Date.now(),
    likes: [],
    dislikes: []
  });
  input.value = "";
  saveToFirebase();
  renderComments();
}

function likeComment(idx) {
  const c = comments[activeList][idx];
  if(!c.likes) c.likes = [];
  if(!c.dislikes) c.dislikes = [];
  if(c.likes.includes(viewer)) {
    c.likes = c.likes.filter(u => u !== viewer);
  } else {
    c.likes.push(viewer);
    c.dislikes = c.dislikes.filter(u => u !== viewer);
  }
  saveToFirebase();
  renderComments();
}

function dislikeComment(idx) {
  const c = comments[activeList][idx];
  if(!c.likes) c.likes = [];
  if(!c.dislikes) c.dislikes = [];
  if(c.dislikes.includes(viewer)) {
    c.dislikes = c.dislikes.filter(u => u !== viewer);
  } else {
    c.dislikes.push(viewer);
    c.likes = c.likes.filter(u => u !== viewer);
  }
  saveToFirebase();
  renderComments();
}

function deleteComment(idx) {
  if(!confirm("Delete?")) return;
  comments[activeList].splice(idx, 1);
  saveToFirebase();
  renderComments();
}

function renderStatComments(playerId) {
  const comList = document.getElementById("statComList");
  comList.innerHTML = "";
  const key = activeList + "_" + playerId;
  const cm = playerComments[key] || [];
  cm.slice().reverse().forEach((c, idx) => {
    const realIdx = cm.length - 1 - idx;
    const likes = c.likes || [];
    const dislikes = c.dislikes || [];
    comList.innerHTML += `
      <div class="comment">
        <strong style="color:#00ff9c">${c.user}:</strong> ${c.text}
        <div class="comment-actions">
          <span class="comment-btn ${likes.includes(viewer) ? 'liked' : ''}" onclick="likeStatComment('${playerId}',${realIdx})">üëç ${likes.length}</span>
          <span class="comment-btn ${dislikes.includes(viewer) ? 'disliked' : ''}" onclick="dislikeStatComment('${playerId}',${realIdx})">üëé ${dislikes.length}</span>
          ${c.user === viewer ? `<span class="comment-btn" onclick="deleteStatComment('${playerId}',${realIdx})" style="color:#ff4d4d">üóëÔ∏è</span>` : ""}
        </div>
      </div>`;
  });
}

function addStatComment() {
  const input = document.getElementById("statCInput");
  if(!input.value.trim() || currentPlayer === null) return;
  const playerId = lists[activeList][currentPlayer].id;
  const key = activeList + "_" + playerId;
  if(!playerComments[key]) playerComments[key] = [];
  playerComments[key].push({
    user: viewer,
    text: input.value,
    time: Date.now(),
    likes: [],
    dislikes: []
  });
  input.value = "";
  saveToFirebase();
  renderStatComments(playerId);
}

function likeStatComment(playerId, idx) {
  const key = activeList + "_" + playerId;
  const c = playerComments[key][idx];
  if(!c.likes) c.likes = [];
  if(!c.dislikes) c.dislikes = [];
  if(c.likes.includes(viewer)) {
    c.likes = c.likes.filter(u => u !== viewer);
  } else {
    c.likes.push(viewer);
    c.dislikes = c.dislikes.filter(u => u !== viewer);
  }
  saveToFirebase();
  renderStatComments(playerId);
}

function dislikeStatComment(playerId, idx) {
  const key = activeList + "_" + playerId;
  const c = playerComments[key][idx];
  if(!c.dislikes) c.dislikes = [];
  if(c.dislikes.includes(viewer)) {
    c.dislikes = c.dislikes.filter(u => u !== viewer);
  } else {
    c.dislikes.push(viewer);
    c.likes = c.likes.filter(u => u !== viewer);
  }
  saveToFirebase();
  renderStatComments(playerId);
}

function deleteStatComment(playerId, idx) {
  if(!confirm("Delete?")) return;
  const key = activeList + "_" + playerId;
  playerComments[key].splice(idx, 1);
  saveToFirebase();
  renderStatComments(playerId);
}

/* ===== TEAMS SYSTEM - VIEWERS CAN SWITCH BETWEEN 2 TEAMS ===== */
function switchTeamsView(view) {
  document.getElementById("setupView").style.display = "none";
  document.getElementById("squadsView").style.display = "none";
  document.getElementById("emptyState").style.display = "none";
  
  document.getElementById("navSetup").classList.remove("active");
  document.getElementById("navSquads").classList.remove("active");
  
  if(view === 'setup') {
    document.getElementById("setupView").style.display = "block";
    document.getElementById("navSetup").classList.add("active");
    initSetup();
  } else if(view === 'squads') {
    document.getElementById("squadsView").style.display = "block";
    document.getElementById("navSquads").classList.add("active");
    initSquads();
  }
  
  // Scroll to top when switching views
  window.scrollTo(0, 0);
}

function initTeamPage() {
  const nav = document.getElementById("teamsNav");
  
  if(teams.length === 0) {
    nav.style.display = "none";
    document.getElementById("setupView").style.display = isAdmin ? "block" : "none";
    document.getElementById("squadsView").style.display = "none";
    document.getElementById("emptyState").style.display = isAdmin ? "none" : "block";
    if(isAdmin) initSetup();
  } else {
    // For viewers: hide nav, show squads with team switching enabled
    // For admin: show nav with both options
    nav.style.display = isAdmin ? "flex" : "none";
    document.getElementById("emptyState").style.display = "none";
    
    if(isAdmin) {
      // Admin: go to setup by default when clicking Teams tab
      switchTeamsView('setup');
    } else {
      // Viewers: go straight to squads view with all teams available in selector
      document.getElementById("squadsView").style.display = "block";
      initSquads();
    }
  }
}

function initSetup() {
  if(teams.length > 0) {
    tempTeams = JSON.parse(JSON.stringify(teams));
    setupTeamCount = teams.length;
  } else {
    createTempTeams();
  }
  document.getElementById("teamCountDisplay").innerText = setupTeamCount;
  renderSetupGrid();
}

function createTempTeams() {
  tempTeams = [];
  for(let i = 0; i < setupTeamCount; i++) {
    tempTeams.push({
      id: Date.now() + i,
      name: `Team ${i + 1}`,
      maxPlayers: 11,
      customFormation: [],
      icon: "",
      players: []
    });
  }
}

function changeTeamCount(delta) {
  const newCount = Math.max(2, Math.min(8, setupTeamCount + delta));
  if(newCount === setupTeamCount) return;
  
  setupTeamCount = newCount;
  document.getElementById("teamCountDisplay").innerText = setupTeamCount;
  
  if(setupTeamCount > tempTeams.length) {
    for(let i = tempTeams.length; i < setupTeamCount; i++) {
      tempTeams.push({
        id: Date.now() + i,
        name: `Team ${i + 1}`,
        maxPlayers: 11,
        customFormation: [],
        icon: "",
        players: []
      });
    }
  } else if(setupTeamCount < tempTeams.length) {
    const teamsToRemove = tempTeams.slice(setupTeamCount);
    const hasPlayers = teamsToRemove.some(t => t.players && t.players.length > 0);
    if(hasPlayers && !confirm("Some teams have players. Removing will unassign them. Continue?")) {
      setupTeamCount = tempTeams.length;
      document.getElementById("teamCountDisplay").innerText = setupTeamCount;
      return;
    }
    tempTeams = tempTeams.slice(0, setupTeamCount);
  }
  renderSetupGrid();
}

/* ===== FORMATION BUILDER ===== */
let selectedPositionForFormation = null;
let selectedTeamForPosition = null;

function renderSetupGrid() {
  const grid = document.getElementById("setupGrid");
  grid.innerHTML = "";
  
  tempTeams.forEach((team, index) => {
    const card = document.createElement("div");
    card.className = "setup-card";
    
    const isComplete = team.customFormation.length === team.maxPlayers;
    
    card.innerHTML = `
      <div class="setup-card-header">
        ${team.icon ? 
          `<img src="${team.icon}" class="setup-card-icon">` : 
          `<div class="setup-card-icon-placeholder">üèüÔ∏è</div>`
        }
        <div class="setup-card-info">
          <div class="setup-card-title">${team.name}</div>
          <div class="setup-card-meta">${team.maxPlayers} players required</div>
        </div>
      </div>
      
      <div class="setup-card-body">
        <div class="setup-input-group">
          <label>Team Name</label>
          <input type="text" value="${team.name}" onchange="updateTeamName(${index}, this.value)">
        </div>
        <div class="setup-input-group">
          <label>Team Icon</label>
          <input type="file" accept="image/*" onchange="updateTeamIcon(${index}, this)">
        </div>
        
        <div class="formation-workspace">
          <div class="formation-header">
            <span style="font-weight: bold; color: #00ff9c;">Build Formation</span>
            <div class="formation-player-count">
              <button onclick="changePlayerCount(${index}, -1)">‚àí</button>
              <span>${team.maxPlayers}</span>
              <button onclick="changePlayerCount(${index}, 1)">+</button>
            </div>
          </div>
          
          <div class="formation-instructions">
            <strong>How to build:</strong> Click a position below, then click on the pitch to place it. Click a placed position to remove it.
          </div>
          
          <div class="formation-canvas" id="formationCanvas${index}">
            ${renderFormationPositions(team, index)}
          </div>
          
          <div class="formation-position-palette">
            ${availablePositions.map(pos => 
              `<button class="position-option ${selectedPositionForFormation === pos && selectedTeamForPosition === index ? 'selected' : ''}" 
                onclick="selectPositionForFormation(${index}, '${pos}')">${pos}</button>`
            ).join('')}
          </div>
          
          <div class="formation-status ${isComplete ? 'complete' : 'incomplete'}">
            <span>${team.customFormation.length} / ${team.maxPlayers} positions placed</span>
            <span style="color: ${isComplete ? '#00ff9c' : '#ff4d4d'}">${isComplete ? '‚úì Complete' : 'Incomplete'}</span>
          </div>
        </div>
      </div>
      
      <div class="setup-card-actions">
        <button class="btn-secondary" onclick="clearTeamSetup(${index})">Clear</button>
        <button class="btn-danger" onclick="removeTeamSetup(${index})">Remove</button>
      </div>
    `;
    
    grid.appendChild(card);
    
    setTimeout(() => {
      const canvas = document.getElementById(`formationCanvas${index}`);
      if(canvas) {
        canvas.onclick = (e) => handleCanvasClick(e, index, canvas);
      }
    }, 0);
  });
}

function selectPositionForFormation(teamIndex, pos) {
  selectedPositionForFormation = pos;
  selectedTeamForPosition = teamIndex;
  renderSetupGrid();
}

function renderFormationPositions(team, teamIndex) {
  if(team.customFormation.length === 0) {
    return '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #555; text-align: center;">Click a position type above,<br>then click here to place</div>';
  }
  
  let html = '';
  team.customFormation.forEach((pos, idx) => {
    const coords = getFormationCoords(idx, team.customFormation.length, team.maxPlayers);
    html += `
      <div class="formation-position occupied" 
           style="left: ${coords.x}%; top: ${coords.y}%;"
           onclick="removeFormationPosition(${teamIndex}, ${idx}); event.stopPropagation();">
        <div class="formation-position-pos">${pos}</div>
        <div class="formation-position-index">#${idx + 1}</div>
        <button class="formation-position-remove">√ó</button>
      </div>
    `;
  });
  return html;
}

function getFormationCoords(index, total, maxPlayers) {
  const sectionHeight = 70 / Math.max(1, maxPlayers - 1);
  let y = 85 - (index * sectionHeight);
  const patterns = [50, 30, 70, 15, 85, 40, 60, 25, 75, 10, 90];
  const x = patterns[index % patterns.length];
  return {x, y};
}

function handleCanvasClick(e, teamIndex, canvas) {
  if(selectedTeamForPosition !== teamIndex || !selectedPositionForFormation) {
    const hint = document.createElement('div');
    hint.innerText = "Select a position type first!";
    hint.style.cssText = "position: absolute; background: #ff4d4d; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 100;";
    hint.style.left = e.offsetX + 'px';
    hint.style.top = e.offsetY + 'px';
    canvas.appendChild(hint);
    setTimeout(() => hint.remove(), 1500);
    return;
  }
  
  const team = tempTeams[teamIndex];
  if(team.customFormation.length >= team.maxPlayers) {
    alert("Formation complete! Remove a position to add another.");
    return;
  }
  
  team.customFormation.push(selectedPositionForFormation);
  renderSetupGrid();
}

function removeFormationPosition(teamIndex, posIndex) {
  tempTeams[teamIndex].customFormation.splice(posIndex, 1);
  renderSetupGrid();
}

function changePlayerCount(teamIndex, delta) {
  const team = tempTeams[teamIndex];
  const newCount = Math.max(5, Math.min(22, team.maxPlayers + delta));
  
  if(newCount < team.customFormation.length) {
    if(!confirm(`Will remove last ${team.customFormation.length - newCount} positions. Continue?`)) return;
    team.customFormation = team.customFormation.slice(0, newCount);
  }
  
  team.maxPlayers = newCount;
  renderSetupGrid();
}

function updateTeamName(index, name) {
  tempTeams[index].name = name;
}

function updateTeamIcon(index, input) {
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    tempTeams[index].icon = e.target.result;
    renderSetupGrid();
  };
  reader.readAsDataURL(file);
}

function clearTeamSetup(index) {
  tempTeams[index].name = `Team ${index + 1}`;
  tempTeams[index].maxPlayers = 11;
  tempTeams[index].customFormation = [];
  tempTeams[index].icon = "";
  renderSetupGrid();
}

function removeTeamSetup(index) {
  if(tempTeams[index].players && tempTeams[index].players.length > 0) {
    if(!confirm("This team has players. Remove will unassign them. Continue?")) return;
  }
  tempTeams.splice(index, 1);
  setupTeamCount--;
  document.getElementById("teamCountDisplay").innerText = setupTeamCount;
  tempTeams.forEach((t, i) => {
    if(t.name.match(/^Team \d+$/)) t.name = `Team ${i + 1}`;
  });
  renderSetupGrid();
}

function resetTeams() {
  if(!confirm("Reset all teams?")) return;
  tempTeams = [];
  setupTeamCount = 2;
  createTempTeams();
  document.getElementById("teamCountDisplay").innerText = setupTeamCount;
  renderSetupGrid();
}

function analyzeAndSuggestFormations() {
  if(lists.all.length === 0) {
    alert("Add players to All-Time list first!");
    return;
  }
  
  const posCounts = {};
  lists.all.forEach(p => {
    posCounts[p.pos] = (posCounts[p.pos] || 0) + 1;
  });
  
  tempTeams.forEach((team, idx) => {
    const formation = buildOptimalFormation(posCounts, team.maxPlayers);
    team.customFormation = formation;
    formation.forEach(pos => {
      if(posCounts[pos] > 0) posCounts[pos]--;
    });
  });
  
  renderSetupGrid();
  alert("Formations auto-built based on your player positions!");
}

function buildOptimalFormation(posCounts, maxPlayers) {
  const formation = [];
  if(posCounts["GK"] > 0) formation.push("GK");
  else formation.push("CB");
  
  const priorities = ["CB", "CM", "ST", "LW", "RW", "LB", "RB", "CDM", "CAM", "LM", "RM"];
  
  for(let pos of priorities) {
    if(formation.length >= maxPlayers) break;
    const count = posCounts[pos] || 0;
    const toAdd = Math.min(count, 2, maxPlayers - formation.length);
    for(let i = 0; i < toAdd; i++) formation.push(pos);
  }
  
  while(formation.length < maxPlayers) {
    formation.push(formation.length % 2 === 0 ? "CM" : "ST");
  }
  
  return formation;
}

function autoGenerateTeams() {
  if(!confirm("Auto-generate balanced teams?")) return;
  const allPlayers = [...lists.all];
  const totalNeeded = tempTeams.reduce((sum, t) => sum + t.maxPlayers, 0);
  
  if(allPlayers.length < totalNeeded) {
    alert(`Need ${totalNeeded} players, have ${allPlayers.length}`);
    return;
  }
  
  allPlayers.sort((a, b) => ovr(b) - ovr(a));
  tempTeams.forEach(t => t.players = []);
  
  let playerIdx = 0;
  tempTeams.forEach(team => {
    for(let i = 0; i < team.maxPlayers && playerIdx < allPlayers.length; i++) {
      const player = allPlayers[playerIdx++];
      team.players.push({
        playerId: player.id,
        name: player.name,
        ovr: ovr(player),
        slotIndex: i,
        isBench: false
      });
    }
  });
  
  alert("Teams generated!");
  renderSetupGrid();
}

function saveTeamsAndGoToSquads() {
  const emptyNames = tempTeams.filter(t => !t.name.trim());
  if(emptyNames.length > 0) {
    alert("Fill in all team names");
    return;
  }
  
  const incomplete = tempTeams.filter(t => t.customFormation.length !== t.maxPlayers);
  if(incomplete.length > 0) {
    alert("Complete all formations first");
    return;
  }
  
  teams = JSON.parse(JSON.stringify(tempTeams));
  teams.forEach(t => { if(!t.players) t.players = []; });
  saveToFirebase();
  
  // Switch to squads view and scroll to top
  switchTeamsView('squads');
  window.scrollTo(0, 0);
  document.getElementById('squadsView').scrollTop = 0;
  document.querySelector('.squad-builder-container').scrollTop = 0;
}

function backToSetup() {
  if(!isAdmin) return;
  if(confirm("Go back to setup? Current squad changes will be lost.")) {
    if(teams.length > 0) {
      tempTeams = JSON.parse(JSON.stringify(teams));
      setupTeamCount = teams.length;
    }
    switchTeamsView('setup');
  }
}

/* ===== SQUADS - VIEWERS CAN SWITCH BETWEEN ALL TEAMS ===== */
function initSquads() {
  renderTeamList();
  renderTeamSelector();
  
  // Apply viewer mode styling if not admin
  const container = document.getElementById('squadBuilderContainer');
  if(!isAdmin) {
    container.classList.add('viewer-mode');
    document.body.classList.add('viewer-mode');
  } else {
    container.classList.remove('viewer-mode');
    document.body.classList.remove('viewer-mode');
  }
  
  // Load first team by default, or current team if set
  if(teams.length > 0) {
    const teamToLoad = currentTeamId && teams.find(t => t.id == currentTeamId) 
      ? currentTeamId 
      : teams[0].id;
    loadTeam(teamToLoad);
  }
  
  // Enable team selector for everyone (viewers can switch teams)
  document.getElementById("teamSelector").disabled = false;
  
  // Scroll to top to ensure full view
  window.scrollTo(0, 0);
  document.getElementById('squadsView').scrollTop = 0;
}

function renderTeamList() {
  const list = document.getElementById("teamList");
  list.innerHTML = "";
  
  // Show all teams for both admin and viewers
  // Viewers can see the list but can't interact (CSS handles this)
  teams.forEach(team => {
    const div = document.createElement("div");
    div.className = "team-list-item" + (team.id == currentTeamId ? " active" : "");
    // Only allow click for admin
    div.onclick = () => isAdmin ? loadTeam(team.id) : null;
    
    const avgOvr = calculateTeamOVR(team);
    const starters = team.players.filter(p => !p.isBench).length;
    const max = team.maxPlayers || team.customFormation.length;
    
    div.innerHTML = `
      ${team.icon ? `<img src="${team.icon}" class="team-list-icon">` : '<div style="width:30px;height:30px;border-radius:50%;background:#333;"></div>'}
      <div class="team-list-info">
        <div class="team-list-name">${team.name}</div>
        <div class="team-list-stats">${starters}/${max} starters</div>
      </div>
      <div style="background:#00ff9c;color:#000;padding:2px 6px;border-radius:4px;font-weight:bold;font-size:12px;">${avgOvr}</div>
    `;
    list.appendChild(div);
  });
}

function renderTeamSelector() {
  const select = document.getElementById("teamSelector");
  select.innerHTML = '<option value="">Select Team</option>';
  
  // Show all teams in selector for both admin and viewers
  teams.forEach(team => {
    const option = document.createElement("option");
    option.value = team.id;
    option.text = team.name;
    if(team.id == currentTeamId) option.selected = true;
    select.appendChild(option);
  });
}

function loadTeam(teamId) {
  currentTeamId = parseInt(teamId);
  const team = teams.find(t => t.id == currentTeamId);
  if(!team) return;
  
  const max = team.maxPlayers || team.customFormation.length;
  const starters = team.players.filter(p => !p.isBench).length;
  
  document.getElementById("formationDisplay").innerText = `Formation ‚Ä¢ ${starters}/${max} players`;
  document.getElementById("teamOVR").innerText = calculateTeamOVR(team);
  
  const icon = document.getElementById("currentTeamIcon");
  if(team.icon) {
    icon.src = team.icon;
    icon.style.display = "block";
  } else {
    icon.style.display = "none";
  }
  
  renderPitchSlots(team);
  renderBench(team);
  if(isAdmin) renderPool();
  renderTeamList();
  document.getElementById("teamSelector").value = teamId;
}

function calculateTeamOVR(team) {
  if(!team.players || team.players.length === 0) return 0;
  const starters = team.players.filter(p => !p.isBench);
  if(starters.length === 0) return 0;
  const total = starters.reduce((sum, p) => sum + (p.ovr || 0), 0);
  return Math.round(total / starters.length);
}

function renderPitchSlots(team) {
  const container = document.getElementById("playerSlots");
  container.innerHTML = "";
  
  const formation = team.customFormation;
  if(!formation || formation.length === 0) return;
  
  const rows = [[], [], [], [], [], []];
  
  formation.forEach((pos, idx) => {
    const coords = getFormationCoords(idx, formation.length, formation.length);
    const rowIdx = Math.floor((100 - coords.y) / 16.6);
    if(rowIdx >= 0 && rowIdx < 6) {
      rows[rowIdx].push({pos, idx});
    }
  });
  
  rows.forEach((rowData) => {
    if(rowData.length === 0) return;
    
    const rowDiv = document.createElement("div");
    rowDiv.className = "player-slot-row";
    
    rowData.forEach(({pos, idx}) => {
      const player = team.players.find(p => p.slotIndex === idx && !p.isBench);
      
      const slot = document.createElement("div");
      slot.className = "player-slot" + (player ? " occupied" : "");
      slot.dataset.slotIndex = idx;
      
      if(isAdmin && player) {
        slot.onclick = (e) => {
          if(!e.target.classList.contains('player-card-remove')) {
            removePlayerFromSlot(idx);
          }
        };
      }
      
      if(isAdmin) {
        slot.ondragover = (e) => {
          e.preventDefault();
          slot.classList.add('drag-over');
        };
        slot.ondragleave = () => slot.classList.remove('drag-over');
        slot.ondrop = (e) => {
          e.preventDefault();
          slot.classList.remove('drag-over');
          handlePlayerDrop(idx, false);
        };
      }
      
      if(player) {
        const pData = lists.all.find(p => p.id == player.playerId);
        const position = pData ? pData.pos : '';
        slot.innerHTML = `
          <div class="player-card-small">
            <span class="player-card-rating">${player.ovr}</span>
            <span class="player-card-position">${position}</span>
            <img src="${pData?.photo || 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2750%27 height=%2750%27%3E%3Crect fill=%27%23333%27 width=%2750%27 height=%2750%27/%3E%3Ctext fill=%27%23666%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3E‚öΩ%3C/text%3E%3C/svg%3E'}" class="player-card-photo">
            <div class="player-card-name">${player.name}</div>
            ${isAdmin ? `<button class="player-card-remove" onclick="event.stopPropagation(); removePlayerFromSlot(${idx})">√ó</button>` : ''}
          </div>
        `;
      } else {
        slot.innerHTML = `
          <div class="player-slot-position">${pos}</div>
          ${isAdmin ? '<div class="player-slot-add">+</div>' : '<div style="color:#444;font-size:11px;">Empty</div>'}
        `;
      }
      
      rowDiv.appendChild(slot);
    });
    
    container.appendChild(rowDiv);
  });
}

function renderBench(team) {
  const container = document.getElementById("benchSlots");
  container.innerHTML = "";
  
  const benchSize = Math.min(7, Math.max(3, Math.floor((team.maxPlayers || 11) / 2)));
  
  for(let i = 0; i < benchSize; i++) {
    const player = team.players.find(p => p.isBench && p.benchIndex === i);
    
    const slot = document.createElement("div");
    slot.className = "bench-slot" + (player ? " occupied" : "");
    slot.dataset.benchIndex = i;
    
    if(isAdmin) {
      slot.ondragover = (e) => {
        e.preventDefault();
        slot.classList.add('drag-over');
      };
      slot.ondragleave = () => slot.classList.remove('drag-over');
      slot.ondrop = (e) => {
        e.preventDefault();
        slot.classList.remove('drag-over');
        handlePlayerDrop(i, true);
      };
    }
    
    if(player) {
      const pData = lists.all.find(p => p.id == player.playerId);
      if(isAdmin) slot.onclick = () => removePlayerFromBench(i);
      slot.innerHTML = `
        <img src="${pData?.photo || 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2735%27 height=%2735%27%3E%3Crect fill=%27%23333%27 width=%2735%27 height=%2735%27/%3E%3Ctext fill=%27%23666%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27 font-size=%2720%27%3E‚öΩ%3C/text%3E%3C/svg%3E'}" class="player-card-photo" style="width:35px;height:35px;">
        <div style="font-size:9px;margin-top:2px;max-width:55px;overflow:hidden;text-overflow:ellipsis;">${player.name}</div>
      `;
    } else {
      slot.innerHTML = isAdmin ? '<div style="color:#555;font-size:20px;">+</div>' : '<div style="color:#444;font-size:10px;">Empty</div>';
    }
    
    container.appendChild(slot);
  }
}

function renderPool() {
  const container = document.getElementById("poolList");
  container.innerHTML = "";
  
  const team = teams.find(t => t.id == currentTeamId);
  if(!team) return;
  
  // Get all players already assigned to ANY team
  const assignedIds = teams.flatMap(t => t.players.map(p => p.playerId));
  
  // Show ALL players from all-time list who aren't assigned yet
  const available = lists.all.filter(p => !assignedIds.includes(p.id));
  
  document.getElementById("poolCount").innerText = available.length;
  
  if(available.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">All players assigned to teams</div>';
    return;
  }
  
  available.forEach(player => {
    const div = document.createElement("div");
    div.className = "pool-player";
    div.draggable = true;
    div.dataset.playerId = player.id;
    
    div.ondragstart = (e) => {
      draggedPlayer = player;
      div.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'copy';
    };
    div.ondragend = () => {
      div.classList.remove('dragging');
      draggedPlayer = null;
    };
    
    div.innerHTML = `
      <img src="${player.photo || 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2735%27 height=%2735%27%3E%3Crect fill=%27%23333%27 width=%2735%27 height=%2735%27/%3E%3Ctext fill=%27%23666%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27 font-size=%2720%27%3E‚öΩ%3C/text%3E%3C/svg%3E'}" class="pool-player-photo">
      <div class="pool-player-info">
        <div class="pool-player-name">${player.name}</div>
        <div class="pool-player-stats">${player.pos} ‚Ä¢ OVR ${ovr(player)}</div>
      </div>
      <div class="pool-player-ovr">${ovr(player)}</div>
    `;
    
    container.appendChild(div);
  });
}

function filterPool() {
  const search = document.getElementById("poolSearch").value.toLowerCase();
  document.querySelectorAll(".pool-player").forEach(p => {
    const name = p.querySelector(".pool-player-name").innerText.toLowerCase();
    p.style.display = name.includes(search) ? "flex" : "none";
  });
}

function handlePlayerDrop(slotIndex, isBench) {
  if(!draggedPlayer || !currentTeamId) return;
  
  const team = teams.find(t => t.id == currentTeamId);
  const max = team.maxPlayers || team.customFormation.length;
  
  if(team.players.length >= max && !isBench) {
    alert("Team full!");
    return;
  }
  
  const alreadyAssigned = teams.some(t => t.players.find(p => p.playerId === draggedPlayer.id));
  if(alreadyAssigned) {
    alert("Player already on a team!");
    return;
  }
  
  team.players.push({
    playerId: draggedPlayer.id,
    name: draggedPlayer.name,
    ovr: ovr(draggedPlayer),
    slotIndex: isBench ? -1 : slotIndex,
    benchIndex: isBench ? slotIndex : -1,
    isBench: isBench
  });
  
  saveToFirebase();
  loadTeam(currentTeamId);
  renderPool();
  draggedPlayer = null;
}

function removePlayerFromSlot(slotIdx) {
  if(!currentTeamId) return;
  const team = teams.find(t => t.id == currentTeamId);
  team.players = team.players.filter(p => !(p.slotIndex === slotIdx && !p.isBench));
  saveToFirebase();
  loadTeam(currentTeamId);
}

function removePlayerFromBench(benchIdx) {
  if(!currentTeamId) return;
  const team = teams.find(t => t.id == currentTeamId);
  team.players = team.players.filter(p => !(p.benchIndex === benchIdx && p.isBench));
  saveToFirebase();
  loadTeam(currentTeamId);
}

function deleteCurrentTeam() {
  if(!currentTeamId || !isAdmin) return;
  if(!confirm("Delete this team?")) return;
  teams = teams.filter(t => t.id != currentTeamId);
  currentTeamId = null;
  saveToFirebase();
  if(teams.length === 0) initTeamPage();
  else initSquads();
}

function clearSquad() {
  if(!currentTeamId || !isAdmin) return;
  if(!confirm("Remove all players?")) return;
  const team = teams.find(t => t.id == currentTeamId);
  team.players = [];
  saveToFirebase();
  loadTeam(currentTeamId);
}

function switchTeam(teamId) {
  if(teamId) loadTeam(teamId);
}

/* ===== MATCHES SYSTEM ===== */
function initMatchPage() {
  renderMatches();
}

function switchMatchTab(tab) {
  activeMatchTab = tab;
  document.querySelectorAll(".match-tab").forEach(t => t.classList.remove("active"));
  document.getElementById("matchTab" + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add("active");
  renderMatches();
}

function renderMatches() {
  const container = document.getElementById("matchList");
  container.innerHTML = "";
  
  let filtered = matches;
  if(activeMatchTab === 'upcoming') filtered = matches.filter(m => m.isUpcoming);
  else if(activeMatchTab === 'past') filtered = matches.filter(m => !m.isUpcoming);
  
  filtered.sort((a, b) => b.date - a.date);
  
  if(filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìÖ</div>
        <h3>No ${activeMatchTab === 'all' ? '' : activeMatchTab} matches</h3>
        <p>${isAdmin ? 'Click "Set Match" to create one' : 'Check back later'}</p>
      </div>
    `;
    return;
  }
  
  filtered.forEach(match => {
    const homeTeam = teams.find(t => t.id == match.homeTeamId) || {name: "Unknown", icon: ""};
    const awayTeam = teams.find(t => t.id == match.awayTeamId) || {name: "Unknown", icon: ""};
    
    const div = document.createElement("div");
    div.className = "match-item" + (match.isUpcoming ? " upcoming" : "");
    div.onclick = () => showMatchDetail(match.id);
    
    let scorersHtml = "";
    if(match.scorers && match.scorers.length > 0 && !match.isUpcoming) {
      const homeScorers = match.scorers.filter(s => s.team === 'home');
      const awayScorers = match.scorers.filter(s => s.team === 'away');
      
      if(homeScorers.length > 0) {
        scorersHtml += `<div class="match-scorers"><strong>${homeTeam.name}:</strong> ${homeScorers.map(s => {
          return s.name + (s.assist ? ` <span class="match-assist">(${s.assist})</span>` : '');
        }).join(', ')}</div>`;
      }
      if(awayScorers.length > 0) {
        scorersHtml += `<div class="match-scorers"><strong>${awayTeam.name}:</strong> ${awayScorers.map(s => {
          return s.name + (s.assist ? ` <span class="match-assist">(${s.assist})</span>` : '');
        }).join(', ')}</div>`;
      }
    }
    
    div.innerHTML = `
      <div class="match-teams">
        <div class="match-team home">
          <div class="match-team-name">${homeTeam.name}</div>
          ${homeTeam.icon ? `<img src="${homeTeam.icon}" class="match-team-icon">` : '<div style="width:40px;height:40px;border-radius:50%;background:#333;"></div>'}
        </div>
        
        <div class="match-score">
          ${match.isUpcoming ? 
            '<div class="match-status upcoming">VS</div>' :
            `<div class="match-score-value">${match.homeScore} - ${match.awayScore}</div>
             <div class="match-status">FINAL</div>`
          }
        </div>
        
        <div class="match-team away">
          ${awayTeam.icon ? `<img src="${awayTeam.icon}" class="match-team-icon">` : '<div style="width:40px;height:40px;border-radius:50%;background:#333;"></div>'}
          <div class="match-team-name">${awayTeam.name}</div>
        </div>
      </div>
      
      <div class="match-details">
        ${scorersHtml}
        <div class="match-date">${new Date(match.date).toLocaleDateString()} ‚Ä¢ ${match.category.toUpperCase()}</div>
      </div>
    `;
    
    container.appendChild(div);
  });
}

function showMatchDetail(matchId) {
  currentMatchId = matchId;
  const match = matches.find(m => m.id == matchId);
  if(!match) return;
  
  document.getElementById("matchList").classList.add("hidden");
  document.getElementById("matchDetailView").classList.remove("hidden");
  
  const homeTeam = teams.find(t => t.id == match.homeTeamId) || {name: "Unknown", icon: ""};
  const awayTeam = teams.find(t => t.id == match.awayTeamId) || {name: "Unknown", icon: ""};
  
  document.getElementById("detailHomeName").innerText = homeTeam.name;
  document.getElementById("detailAwayName").innerText = awayTeam.name;
  document.getElementById("detailHomeIcon").src = homeTeam.icon || "";
  document.getElementById("detailAwayIcon").src = awayTeam.icon || "";
  document.getElementById("detailScore").innerText = match.isUpcoming ? "VS" : `${match.homeScore} - ${match.awayScore}`;
  
  const statusEl = document.getElementById("detailStatus");
  statusEl.innerText = match.isUpcoming ? "Upcoming" : "Finished";
  statusEl.className = "match-status " + (match.isUpcoming ? "upcoming" : "");
  
  document.getElementById("detailCategory").innerText = match.category.toUpperCase();
  
  const statsContainer = document.getElementById("matchStats");
  if(match.isUpcoming) {
    statsContainer.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">Match not played yet</div>';
  } else {
    statsContainer.innerHTML = `
      <div class="match-stat-row">
        <div class="match-stat-value">${match.homeScore}</div>
        <div class="match-stat-label">Goals</div>
        <div class="match-stat-value">${match.awayScore}</div>
      </div>
    `;
    
    if(match.scorers.length > 0) {
      statsContainer.innerHTML += '<div style="margin-top:20px;padding-top:20px;border-top:1px solid #333;">';
      match.scorers.forEach(s => {
        const teamName = s.team === 'home' ? homeTeam.name : awayTeam.name;
        statsContainer.innerHTML += `
          <div style="padding:8px;background:#0a0f1f;border-radius:6px;margin-bottom:8px;">
            <strong>${s.name}</strong> (${teamName})
            ${s.assist ? `<span style="color:#888;"> ‚Üê ${s.assist}</span>` : ''}
          </div>
        `;
      });
      statsContainer.innerHTML += '</div>';
    }
  }
  
  renderMatchComments();
  
  const statusBtn = document.getElementById("statusToggleBtn");
  if(statusBtn) statusBtn.innerText = match.isUpcoming ? "Mark as Played" : "Mark as Upcoming";
}

function backToMatchList() {
  document.getElementById("matchDetailView").classList.add("hidden");
  document.getElementById("matchList").classList.remove("hidden");
  currentMatchId = null;
  editingMatch = null;
}

function showMatchForm() {
  document.getElementById("matchList").classList.add("hidden");
  document.getElementById("matchForm").classList.remove("hidden");
  document.getElementById("matchFormTitle").innerText = editingMatch ? "Edit Match" : "Set New Match";
  
  const homeSelect = document.getElementById("matchHomeTeam");
  const awaySelect = document.getElementById("matchAwayTeam");
  homeSelect.innerHTML = "";
  awaySelect.innerHTML = "";
  
  teams.forEach(team => {
    homeSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
    awaySelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
  });
  
  if(editingMatch) {
    homeSelect.value = editingMatch.homeTeamId;
    awaySelect.value = editingMatch.awayTeamId;
    document.getElementById("matchHomeScore").value = editingMatch.homeScore;
    document.getElementById("matchAwayScore").value = editingMatch.awayScore;
    document.getElementById("matchIsUpcoming").checked = editingMatch.isUpcoming;
    selectCategory(editingMatch.category);
    
    const scorersList = document.getElementById("scorersList");
    scorersList.innerHTML = "";
    editingMatch.scorers.forEach(s => {
      scorersList.innerHTML += `
        <div class="scorer-row">
          <select class="scorer-team">
            <option value="home" ${s.team === 'home' ? 'selected' : ''}>Home</option>
            <option value="away" ${s.team === 'away' ? 'selected' : ''}>Away</option>
          </select>
          <input type="text" class="scorer-name" placeholder="Scorer name" value="${s.name}">
          <input type="text" class="assist-name" placeholder="Assist by (optional)" value="${s.assist || ''}">
          <button onclick="this.parentElement.remove()" class="btn-danger" style="padding: 5px 10px;">√ó</button>
        </div>
      `;
    });
  } else {
    document.getElementById("matchHomeScore").value = 0;
    document.getElementById("matchAwayScore").value = 0;
    document.getElementById("matchIsUpcoming").checked = true;
    selectCategory('league');
    document.getElementById("scorersList").innerHTML = `
      <div class="scorer-row">
        <select class="scorer-team">
          <option value="home">Home</option>
          <option value="away">Away</option>
        </select>
        <input type="text" class="scorer-name" placeholder="Scorer name">
        <input type="text" class="assist-name" placeholder="Assist by (optional)">
        <button onclick="this.parentElement.remove()" class="btn-danger" style="padding: 5px 10px;">√ó</button>
      </div>
    `;
  }
  
  toggleMatchFormMode();
}

function selectCategory(cat) {
  selectedMatchCategory = cat;
  document.querySelectorAll(".category-btn").forEach(btn => {
    btn.classList.toggle("selected", btn.dataset.cat === cat);
  });
}

function toggleMatchFormMode() {
  const isUpcoming = document.getElementById("matchIsUpcoming").checked;
  document.getElementById("scoreSection").style.display = isUpcoming ? "none" : "block";
}

function addScorerRow() {
  const div = document.createElement("div");
  div.className = "scorer-row";
  div.innerHTML = `
    <select class="scorer-team">
      <option value="home">Home</option>
      <option value="away">Away</option>
    </select>
    <input type="text" class="scorer-name" placeholder="Scorer name">
    <input type="text" class="assist-name" placeholder="Assist by (optional)">
    <button onclick="this.parentElement.remove()" class="btn-danger" style="padding: 5px 10px;">√ó</button>
  `;
  document.getElementById("scorersList").appendChild(div);
}

function saveMatch() {
  const homeId = document.getElementById("matchHomeTeam").value;
  const awayId = document.getElementById("matchAwayTeam").value;
  
  if(homeId === awayId) {
    alert("Select different teams!");
    return;
  }
  
  const isUpcoming = document.getElementById("matchIsUpcoming").checked;
  const homeScore = parseInt(document.getElementById("matchHomeScore").value) || 0;
  const awayScore = parseInt(document.getElementById("matchAwayScore").value) || 0;
  
  const scorers = [];
  if(!isUpcoming) {
    document.querySelectorAll(".scorer-row").forEach(row => {
      const team = row.querySelector(".scorer-team").value;
      const name = row.querySelector(".scorer-name").value.trim();
      const assist = row.querySelector(".assist-name").value.trim();
      if(name) scorers.push({team, name, assist});
    });
  }
  
  if(editingMatch) {
    editingMatch.homeTeamId = parseInt(homeId);
    editingMatch.awayTeamId = parseInt(awayId);
    editingMatch.homeScore = homeScore;
    editingMatch.awayScore = awayScore;
    editingMatch.isUpcoming = isUpcoming;
    editingMatch.scorers = scorers;
    editingMatch.category = selectedMatchCategory;
  } else {
    matches.push({
      id: Date.now(),
      homeTeamId: parseInt(homeId),
      awayTeamId: parseInt(awayId),
      homeScore,
      awayScore,
      isUpcoming,
      scorers,
      category: selectedMatchCategory,
      date: Date.now(),
      comments: []
    });
  }
  
  saveToFirebase();
  editingMatch = null;
  document.getElementById("matchForm").classList.add("hidden");
  document.getElementById("matchList").classList.remove("hidden");
  renderMatches();
}

function cancelMatchForm() {
  editingMatch = null;
  document.getElementById("matchForm").classList.add("hidden");
  document.getElementById("matchList").classList.remove("hidden");
}

function editMatch() {
  const match = matches.find(m => m.id == currentMatchId);
  if(!match) return;
  editingMatch = match;
  showMatchForm();
}

function deleteMatch() {
  if(!confirm("Delete this match?")) return;
  matches = matches.filter(m => m.id != currentMatchId);
  saveToFirebase();
  backToMatchList();
}

function toggleMatchStatus() {
  const match = matches.find(m => m.id == currentMatchId);
  if(!match) return;
  match.isUpcoming = !match.isUpcoming;
  saveToFirebase();
  showMatchDetail(currentMatchId);
}

function renderMatchComments() {
  const container = document.getElementById("matchComments");
  const match = matches.find(m => m.id == currentMatchId);
  if(!match || !match.comments || match.comments.length === 0) {
    container.innerHTML = "<p style='color:#666;'>No comments yet</p>";
    return;
  }
  
  container.innerHTML = "";
  match.comments.slice().reverse().forEach(c => {
    container.innerHTML += `
      <div class="comment">
        <strong style="color:#00ff9c">${c.user}:</strong> ${c.text}
      </div>
    `;
  });
}

function addMatchComment() {
  const input = document.getElementById("matchCommentInput");
  if(!input.value.trim() || !currentMatchId) return;
  
  const match = matches.find(m => m.id == currentMatchId);
  if(!match.comments) match.comments = [];
  
  match.comments.push({
    user: viewer,
    text: input.value,
    time: Date.now()
  });
  
  input.value = "";
  saveToFirebase();
  renderMatchComments();
}

/* ===== STARTUP ===== */
initAuth();
</script>

</body>
</html>